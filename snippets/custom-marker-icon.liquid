{%- comment -%}
  Custom Marker Icon for Dealer Search
  Parameters:
  - store_type: dealer, rental, service, click-collect
  - size: small, medium, large (default: medium)
{%- endcomment -%}

{%- assign store_type = store_type | default: 'dealer' -%}
{%- assign size = size | default: 'medium' -%}

{%- case size -%}
  {%- when 'small' -%}
    {%- assign width = 36 -%}
    {%- assign height = 46 -%}
    {%- assign icon_size = 18 -%}
    {%- assign circle_radius = 14 -%}
  {%- when 'large' -%}
    {%- assign width = 54 -%}
    {%- assign height = 68 -%}
    {%- assign icon_size = 28 -%}
    {%- assign circle_radius = 21 -%}
  {%- else -%}
    {%- assign width = 44 -%}
    {%- assign height = 56 -%}
    {%- assign icon_size = 22 -%}
    {%- assign circle_radius = 17 -%}
{%- endcase -%}

{%- case store_type -%}
  {%- when 'dealer' -%}
    {%- assign primary_color = '#2563eb' -%}
    {%- assign secondary_color = '#1d4ed8' -%}
    {%- assign accent_color = '#3b82f6' -%}
    {%- assign icon_color = '#ffffff' -%}
  {%- when 'rental' -%}
    {%- assign primary_color = '#059669' -%}
    {%- assign secondary_color = '#047857' -%}
    {%- assign accent_color = '#10b981' -%}
    {%- assign icon_color = '#ffffff' -%}
  {%- when 'service' -%}
    {%- assign primary_color = '#dc2626' -%}
    {%- assign secondary_color = '#b91c1c' -%}
    {%- assign accent_color = '#ef4444' -%}
    {%- assign icon_color = '#ffffff' -%}
  {%- when 'click-collect' -%}
    {%- assign primary_color = '#7c3aed' -%}
    {%- assign secondary_color = '#6d28d9' -%}
    {%- assign accent_color = '#8b5cf6' -%}
    {%- assign icon_color = '#ffffff' -%}
  {%- else -%}
    {%- assign primary_color = '#6b7280' -%}
    {%- assign secondary_color = '#4b5563' -%}
    {%- assign accent_color = '#9ca3af' -%}
    {%- assign icon_color = '#ffffff' -%}
{%- endcase -%}

{%- assign center_x = width | divided_by: 2 -%}
{%- assign center_y = circle_radius | plus: 6 -%}
{%- assign icon_x = center_x | minus: icon_size | divided_by: 2 -%}
{%- assign icon_y = center_y | minus: icon_size | divided_by: 2 -%}

<svg width="{{ width }}" height="{{ height }}" viewBox="0 0 {{ width }} {{ height }}" fill="none" xmlns="http://www.w3.org/2000/svg" class="custom-marker custom-marker--{{ store_type }}">
  <!-- Marker Background -->
  <defs>
    <linearGradient id="marker-gradient-{{ store_type }}" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:{{ accent_color }};stop-opacity:1" />
      <stop offset="50%" style="stop-color:{{ primary_color }};stop-opacity:1" />
      <stop offset="100%" style="stop-color:{{ secondary_color }};stop-opacity:1" />
    </linearGradient>
    <filter id="marker-shadow-{{ store_type }}" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
      <feOffset dx="0" dy="4" result="offset"/>
      <feFlood flood-color="#000000" flood-opacity="0.25"/>
      <feComposite in2="offset" operator="in"/>
      <feMerge> 
        <feMergeNode/>
        <feMergeNode in="SourceGraphic"/> 
      </feMerge>
    </filter>
    <filter id="inner-shadow-{{ store_type }}">
      <feOffset dx="0" dy="1"/>
      <feGaussianBlur stdDeviation="1" result="offset-blur"/>
      <feFlood flood-color="#ffffff" flood-opacity="0.3"/>
      <feComposite in2="offset-blur" operator="in"/>
      <feMerge> 
        <feMergeNode in="SourceGraphic"/>
        <feMergeNode/>
      </feMerge>
    </filter>
  </defs>
  
  <!-- Modern Marker Shape -->
  <g filter="url(#marker-shadow-{{ store_type }})">
    <!-- Main circle -->
    <circle cx="{{ center_x }}" cy="{{ center_y }}" r="{{ circle_radius }}" 
            fill="url(#marker-gradient-{{ store_type }})" 
            stroke="#ffffff" 
            stroke-width="2"/>
    
    <!-- Pointer tail -->
    <path d="M{{ center_x | minus: 8 }} {{ center_y | plus: circle_radius | minus: 2 }} 
             L{{ center_x }} {{ height | minus: 3 }} 
             L{{ center_x | plus: 8 }} {{ center_y | plus: circle_radius | minus: 2 }} 
             A{{ circle_radius }} {{ circle_radius }} 0 0 0 {{ center_x | minus: 8 }} {{ center_y | plus: circle_radius | minus: 2 }} Z" 
          fill="url(#marker-gradient-{{ store_type }})" 
          stroke="#ffffff" 
          stroke-width="2"/>
  </g>
  
  <!-- Inner highlight -->
  <circle cx="{{ center_x }}" cy="{{ center_y }}" r="{{ circle_radius | minus: 3 }}" 
          fill="none" 
          stroke="rgba(255,255,255,0.3)" 
          stroke-width="1"/>
  
  <!-- Icon background circle -->
  <circle cx="{{ center_x }}" cy="{{ center_y }}" r="{{ icon_size | divided_by: 2 | plus: 2 }}" 
          fill="rgba(255,255,255,0.15)" 
          filter="url(#inner-shadow-{{ store_type }})"/>
  
  <!-- Hepha Brand Icon (perfectly centered) -->
  <g transform="translate({{ icon_x }}, {{ icon_y }}) scale({{ icon_size | divided_by: 878.0 }})">
    <path d="M812.803 390.655C811.283 388.196 807.846 387.804 805.784 389.828C770.081 425.234 506.872 686.252 506.809 686.314C469.336 723.476 408.575 723.476 371.101 686.314C333.628 649.153 333.628 588.897 371.101 551.736C371.101 551.736 482.73 441.14 553.531 370.989C590.005 334.84 610.522 285.801 610.522 234.675L610.585 4.47674C610.585 0.489988 605.731 -1.49306 602.899 1.31626L350.646 251.345C347.813 254.155 342.96 252.172 342.96 248.185V109.31C342.96 105.323 338.107 103.34 335.274 106.149L124.869 314.865H124.994C-43.3964 485.696 -41.6467 759.894 130.243 928.597C301.591 1096.72 580.027 1095.65 750.105 926.263C896.249 780.736 917.141 558.222 812.803 390.655Z" fill="{{ icon_color }}"/>
  </g>
  
  <!-- Subtle glow effect -->
  <circle cx="{{ center_x }}" cy="{{ center_y }}" r="{{ circle_radius | plus: 1 }}" 
          fill="none" 
          stroke="{{ accent_color }}" 
          stroke-width="0.5" 
          opacity="0.6"/>
</svg>