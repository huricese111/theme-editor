<script>
  document.addEventListener('DOMContentLoaded', function() {
    var formSelector = {{ form_selector | json }};
    var emailSelector = {{ email_selector | json }};
    var legalSelector = {{ legal_selector | json }};
    var marketingSelector = {{ marketing_selector | json }};
    var type = {{ type | json }};
    var formTitle = {% if form_title %}{{ form_title | json }}{% else %}null{% endif %};
    var appendHiddenFalse = {% if append_hidden_marketing_false %}true{% else %}false{% endif %};
    var marketingFieldName = {{ marketing_field_name | default: '' | json }};
    var endpoint = '{{ settings.consent_api_url | default: settings.consent_api_base | strip }}';
    var privacyVer = '{{ settings.privacy_version | default: "230220" | strip }}';
    var termsVer = '{{ settings.terms_version | default: "230220" | strip }}';
    var valid = !!endpoint && endpoint !== 'https://example.com' && endpoint !== 'https://example.com/api/consent';
    if (!valid) endpoint = null;
    var form = document.querySelector(formSelector);
    if (!form) return;
    function nowTs(){ return Math.floor(Date.now()/1000); }
    function makeId(){ try { return crypto.randomUUID(); } catch(e){ return 'id-' + Math.random().toString(36).slice(2); } }
    function pad(n){ return (n<10?'0':'')+n; }
    function formatLocalTime(){ var d = new Date(); var off = -d.getTimezoneOffset(); var sign = off>=0?'+':'-'; var oh = Math.floor(Math.abs(off)/60); var om = Math.abs(off)%60; var offset = sign + pad(oh) + ':' + pad(om); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds())+' '+offset; }
    function getCountryInfo(){ var loc = null; try { loc = Intl.DateTimeFormat().resolvedOptions().locale; } catch(e){} if (!loc) { loc = (navigator.languages && navigator.languages[0]) || navigator.language || null; } var code = null; if (loc) { var parts = String(loc).split(/-|_/); if (parts.length>=2) { var last = parts[parts.length-1]; if (/^[A-Z]{2}$/.test(last)) code = last; } } var name = null; try { if (code && typeof Intl.DisplayNames === 'function') { var dn = new Intl.DisplayNames(['en'], { type: 'region' }); name = dn.of(code); } } catch(e){} return { locale: loc || null, country_code: code || null, country: name || null }; }
    form.addEventListener('submit', function(){
      var emailEl = emailSelector ? document.querySelector(emailSelector) : null;
      var legalEl = legalSelector ? document.querySelector(legalSelector) : null;
      var marketingEl = marketingSelector ? document.querySelector(marketingSelector) : null;
      var id = makeId();
      var ts = nowTs();
      var tz = (typeof Intl !== 'undefined' && Intl.DateTimeFormat && Intl.DateTimeFormat().resolvedOptions ? Intl.DateTimeFormat().resolvedOptions().timeZone : null);
      var region = getCountryInfo();
      var payload = {
         id: id, email: emailEl ? emailEl.value : '', privacy: !!(legalEl && legalEl.checked), terms: !!(legalEl && legalEl.checked), 
         marketing: !!marketingEl ? !!marketingEl.checked : null, 
         timestamp: ts, consent_time: formatLocalTime(), 
         timezone: tz, country: region.country, 
         country_code: region.country_code, locale: region.locale, userAgent: navigator.userAgent, type: type, domain: location.hostname, page_url: location.href, privacy_version: privacyVer, terms_version: termsVer };
      if (formTitle) payload.formTitle = formTitle;
      try { console.log('consent payload', payload); } catch(e) {}
      if (marketingFieldName && (!marketingEl || !marketingEl.checked)  ) {
        try {
          var hidden = document.createElement('input');
          hidden.setAttribute('type', 'hidden');
          hidden.setAttribute('name', marketingFieldName);
          hidden.setAttribute('value', 'false');
          form.appendChild(hidden);
        } catch(e) {}
      }
      if (!endpoint) return;
      try {
        var ok = navigator.sendBeacon(endpoint, JSON.stringify(payload));
        if (!ok) {
          fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), keepalive: true, mode: 'cors' }).catch(function(){});
        }
      } catch(e) {}
    });
  });
</script>
