{% schema %}
{
  "name": "Bubble chat",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "text",
      "id": "feedback_title_en",
      "label": "Feedback Title (English)",
      "default": "Hepha.com Experience Feedback"
    },
    {
      "type": "text",
      "id": "feedback_title_de",
      "label": "Feedback Title (German)",
      "default": "Hepha.com Erfahrungsfeedback"
    },
    {
      "type": "text",
      "id": "feedback_title_fr",
      "label": "Feedback Title (French)",
      "default": "Commentaires expérience Hepha.com"
    },
    {
      "type": "text",
      "id": "feedback_title_fi",
      "label": "Feedback Title (Finnish)",
      "default": "Hepha.com käyttökokemus palaute"
    },
    {
      "type": "textarea",
      "id": "feedback_subtitle_en",
      "label": "Feedback Subtitle (English)",
      "default": "Your feedback is important to us and helps us improve our service quality."
    },
    {
      "type": "textarea",
      "id": "feedback_subtitle_de",
      "label": "Feedback Subtitle (German)",
      "default": "Ihr Feedback hilft uns, besser zu werden."
    },
    {
      "type": "textarea",
      "id": "feedback_subtitle_fr",
      "label": "Feedback Subtitle (French)",
      "default": "Vos commentaires sont importants pour nous et nous aident à améliorer la qualité de notre service"
    },
    {
      "type": "textarea",
      "id": "feedback_subtitle_fi",
      "label": "Feedback Subtitle (Finnish)",
      "default": "Palautteesi on meille tärkeää ja auttaa meitä parantamaan palvelumme laatua."
    },
    {
      "type": "header",
      "content": "Question 1 Settings"
    },
    {
      "type": "text",
      "id": "q1_label_en",
      "label": "Q1 Label (English)",
      "default": "How satisfied were you overall with Hepha.com?"
    },
    {
      "type": "text",
      "id": "q1_label_de",
      "label": "Q1 Label (German)",
      "default": "Wie zufrieden waren Sie overall mit Hepha.com?"
    },
    {
      "type": "text",
      "id": "q1_label_fr",
      "label": "Q1 Label (French)",
      "default": "Veuillez évaluer votre expérience globale sur Hepha.com"
    },
    {
      "type": "text",
      "id": "q1_label_fi",
      "label": "Q1 Label (Finnish)",
      "default": "Kuinka tyytyväinen olit kaiken kaikkiaan Hepha.com-sivustoon?"
    },
    {
      "type": "header",
      "content": "Question 2 Settings"
    },
    {
      "type": "text",
      "id": "q2_title_en",
      "label": "Q2 Title (English)",
      "default": "Describe your unresolved question (we'll respond within 24h on weekdays):"
    },
    {
      "type": "text",
      "id": "q2_title_de",
      "label": "Q2 Title (German)",
      "default": "Auf welche Probleme sind Sie gestoßen?"
    },
    {
      "type": "text",
      "id": "q2_title_fr",
      "label": "Q2 Title (French)",
      "default": " Veuillez nous dire quels problèmes vous avez rencontrés"
    },
    {
      "type": "text",
      "id": "q2_title_fi",
      "label": "Q2 Title (Finnish)",
      "default": "Kuvaile ratkaisematon kysymyksesi (vastaamme 24 tunnin sisällä arkipäivisin):"
    },
    {
      "type": "header",
      "content": "Button & Messages"
    },
    {
      "type": "text",
      "id": "submit_button_en",
      "label": "Submit Button (English)",
      "default": "Submit Feedback"
    },
    {
      "type": "text",
      "id": "submit_button_de",
      "label": "Submit Button (German)",
      "default": "Feedback senden"
    },
    {
      "type": "text",
      "id": "submit_button_fr",
      "label": "Submit Button (French)",
      "default": "Soumettre les commentaires"
    },
    {
      "type": "text",
      "id": "submit_button_fi",
      "label": "Submit Button (Finnish)",
      "default": "Lähetä palaute"
    },
    {
      "type": "text",
      "id": "success_title_en",
      "label": "Success Title (English)",
      "default": "Feedback Submitted Successfully!"
    },
    {
      "type": "text",
      "id": "success_title_de",
      "label": "Success Title (German)",
      "default": "Feedback erfolgreich gesendet!"
    },
    {
      "type": "text",
      "id": "success_title_fr",
      "label": "Success Title (French)",
      "default": "Commentaires soumis avec succès!"
    },
    {
      "type": "text",
      "id": "success_title_fi",
      "label": "Success Title (Finnish)",
      "default": "Palaute lähetetty onnistuneesti!"
    },
    {
      "type": "textarea",
      "id": "success_message_en",
      "label": "Success Message (English)",
      "default": "Thank you for your valuable feedback. We will carefully review your suggestions."
    },
    {
      "type": "textarea",
      "id": "success_message_de",
      "label": "Success Message (German)",
      "default": "Vielen Dank für Ihr wertvolles Feedback. Wir werden Ihre Vorschläge sorgfältig prüfen."
    },
    {
      "type": "textarea",
      "id": "success_message_fr",
      "label": "Success Message (French)",
      "default": "Merci pour vos précieux commentaires. Nous examinerons attentivement vos suggestions."
    },
    {
      "type": "textarea",
      "id": "success_message_fi",
      "label": "Success Message (Finnish)",
      "default": "Kiitos arvokkaasta palautteestasi. Tarkastelemme ehdotuksesi huolellisesti."
    }
  ],
  "blocks": [
    {
      "type": "issue_option",
      "name": "Issue Option",
      "settings": [
        {
          "type": "text",
          "id": "issue_value",
          "label": "Issue Value (for form submission)",
          "info": "Use lowercase with hyphens, e.g., incomplete-product-info"
        },
        {
          "type": "text",
          "id": "issue_label_en",
          "label": "Issue Label (English)"
        },
        {
          "type": "text",
          "id": "issue_label_de",
          "label": "Issue Label (German)"
        },
        {
          "type": "text",
          "id": "issue_label_fr",
          "label": "Issue Label (French)"
        },
        {
          "type": "text",
          "id": "issue_label_fi",
          "label": "Issue Label (Finnish)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Bubble chat",
      "category": "Custom",
      "settings": {
        "feedback_title_en": "Hepha.com Experience Feedback",
        "feedback_title_de": "Hepha.com Erfahrungsfeedback",
        "feedback_title_fr": "Commentaires expérience Hepha.com",
        "feedback_title_fi": "Hepha.com käyttökokemus palaute",
        "feedback_subtitle_en": "Your feedback is important to us and helps us improve our service quality.",
        "feedback_subtitle_de": "Ihr Feedback hilft uns, besser zu werden.",
        "feedback_subtitle_fr": "Vos commentaires sont importants pour nous et nous aident à améliorer la qualité de notre service",
        "feedback_subtitle_fi": "Palautteesi on meille tärkeää ja auttaa meitä parantamaan palvelumme laatua.",
        "q1_label_en": "How satisfied were you overall with Hepha.com?",
        "q1_label_de": "Wie zufrieden waren Sie overall mit Hepha.com?",
        "q1_label_fr": "Veuillez évaluer votre expérience globale sur Hepha.com",
        "q1_label_fi": "Kuinka tyytyväinen olit kaiken kaikkiaan Hepha.com-sivustoon?",
        "q2_title_en": "Describe your unresolved question (we'll respond within 24h on weekdays):",
        "q2_title_de": "Auf welche Probleme sind Sie gestoßen?",
        "q2_title_fr": " Veuillez nous dire quels problèmes vous avez rencontrés",
        "q2_title_fi": "Kuvaile ratkaisematon kysymyksesi (vastaamme 24 tunnin sisällä arkipäivisin):",
        "submit_button_en": "Submit Feedback",
        "submit_button_de": "Feedback senden",
        "submit_button_fr": "Soumettre les commentaires",
        "submit_button_fi": "Lähetä palaute",
        "success_title_en": "Feedback Submitted Successfully!",
        "success_title_de": "Feedback erfolgreich gesendet!",
        "success_title_fr": "Commentaires soumis avec succès!",
        "success_title_fi": "Palaute lähetetty onnistuneesti!",
        "success_message_en": "Thank you for your valuable feedback. We will carefully review your suggestions.",
        "success_message_de": "Vielen Dank für Ihr wertvolles Feedback. Wir werden Ihre Vorschläge sorgfältig prüfen.",
        "success_message_fr": "Merci pour vos précieux commentaires. Nous examinerons attentivement vos suggestions.",
        "success_message_fi": "Kiitos arvokkaasta palautteestasi. Tarkastelemme ehdotuksesi huolellisesti."
      },
      "blocks": [
        {
          "type": "issue_option",
          "settings": {
            "issue_value": "incomplete-product-info",
            "issue_label_en": "Incomplete or inaccurate product information",
            "issue_label_de": "Unvollständige oder fehlerhafte Produktinformationen",
            "issue_label_fr": "Informations produit incomplètes ou inexactes",
            "issue_label_fi": "Puutteelliset tai virheelliset tuotetiedot"
          }
        },
        {
          "type": "issue_option",
          "settings": {
            "issue_value": "live-chat-failed",
            "issue_label_en": "Online customer service failure",
            "issue_label_de": "Der Live Chat war nicht erreichbar",
            "issue_label_fr": "Échec du service client en ligne",
            "issue_label_fi": "Live chat ei ollut käytettävissä"
          }
        },
        {
          "type": "issue_option",
          "settings": {
            "issue_value": "find-local-dealer",
            "issue_label_en": "Dealer location information issues",
            "issue_label_de": "Probleme mit Händlerstandort-Informationen",
            "issue_label_fr": "Problèmes d'informations de localisation des revendeurs",
            "issue_label_fi": "Jälleenmyyjän sijaintitietojen ongelmat"
          }
        },
        {
          "type": "issue_option",
          "settings": {
            "issue_value": "navigation-issues",
            "issue_label_en": "Website navigation or layout issues",
            "issue_label_de": "Schwierigkeiten bei der Navigation oder Bedienung der Website",
            "issue_label_fr": "Problèmes de navigation ou de mise en page du site web",
            "issue_label_fi": "Verkkosivuston navigointi- tai asetteluongelmat"
          }
        },
        {
          "type": "issue_option",
          "settings": {
            "issue_value": "other-issues",
            "issue_label_en": "Other issues not listed above",
            "issue_label_de": "Sonstige Probleme",
            "issue_label_fr": "Autres problèmes non listés ci-dessus",
            "issue_label_fi": "Muut yllä luetteloimattomat ongelmat"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<!-- Hepha.com Experience Feedback Form -->
{% comment %} Multi-language support {% endcomment %}
{% assign current_locale = request.locale.iso_code %}

{% comment %} Get translations from section settings {% endcomment %}
{% case current_locale %}
  {% when 'de' %}
    {% assign feedback_title = section.settings.feedback_title_de | default: 'Hepha.com Erfahrungsfeedback' %}
    {% assign feedback_subtitle = section.settings.feedback_subtitle_de | default: 'Ihr Feedback hilft uns, besser zu werden.' %}
    {% assign close_label = 'Feedback-Formular schließen' %}
    {% assign q1_label = section.settings.q1_label_de | default: 'Wie zufrieden waren Sie overall mit Hepha.com?' %}
    {% assign rating_very_poor = 'Sehr unzufrieden' %}
    {% assign rating_poor = 'Eher unzufrieden' %}
    {% assign rating_average = 'Zufrieden' %}
    {% assign rating_good = 'Sehr zufrieden' %}
    {% assign rating_excellent = 'Äußerst zufrieden' %}
    {% assign rating_error = 'Bitte wählen Sie Ihre Bewertung' %}
    {% assign q2_title = section.settings.q2_title_de | default: 'Auf welche Probleme sind Sie gestoßen?' %}
    {% assign issue_error = 'Bitte wählen Sie einen Problemtyp' %}
    {% assign submit_button = section.settings.submit_button_de | default: 'Feedback senden' %}
    {% assign success_title = section.settings.success_title_de | default: 'Feedback erfolgreich gesendet!' %}
    {% assign success_message = section.settings.success_message_de | default: 'Vielen Dank für Ihr wertvolles Feedback. Wir werden Ihre Vorschläge sorgfältig prüfen.' %}
    {% assign close_button = 'Schließen' %}
  {% when 'fr' %}
    {% assign feedback_title = section.settings.feedback_title_fr | default: 'Commentaires expérience Hepha.com' %}
    {% assign feedback_subtitle = section.settings.feedback_subtitle_fr | default: 'Vos commentaires sont importants pour nous et nous aident à améliorer la qualité de notre service' %}
    {% assign close_label = 'Fermer le formulaire de commentaires' %}
    {% assign q1_label = section.settings.q1_label_fr | default: 'Veuillez évaluer votre expérience globale sur Hepha.com' %}
    {% assign rating_very_poor = 'Très insatisfait' %}
    {% assign rating_poor = 'Quelque peu insatisfait' %}
    {% assign rating_average = 'Satisfait' %}
    {% assign rating_good = 'Très satisfait' %}
    {% assign rating_excellent = 'Extrêmement satisfait' %}
    {% assign rating_error = 'Veuillez sélectionner votre évaluation' %}
    {% assign q2_title = section.settings.q2_title_fr | default: ' Veuillez nous dire quels problèmes vous avez rencontrés' %}
    {% assign issue_error = 'Veuillez sélectionner un type de problème' %}
    {% assign submit_button = section.settings.submit_button_fr | default: 'Soumettre les commentaires' %}
    {% assign success_title = section.settings.success_title_fr | default: 'Commentaires soumis avec succès!' %}
    {% assign success_message = section.settings.success_message_fr | default: 'Merci pour vos précieux commentaires. Nous examinerons attentivement vos suggestions.' %}
    {% assign close_button = 'Fermer' %}
  {% when 'fi' %}
    {% assign feedback_title = section.settings.feedback_title_fi | default: 'Hepha.com käyttökokemus palaute' %}
    {% assign feedback_subtitle = section.settings.feedback_subtitle_fi | default: 'Palautteesi on meille tärkeää ja auttaa meitä parantamaan palvelumme laatua.' %}
    {% assign close_label = 'Sulje palautelomake' %}
    {% assign q1_label = section.settings.q1_label_fi | default: 'Kuinka tyytyväinen olit kaiken kaikkiaan Hepha.com-sivustoon?' %}
    {% assign rating_very_poor = 'Erittäin tyytymätön' %}
    {% assign rating_poor = 'Jonkin verran tyytymätön' %}
    {% assign rating_average = 'Tyytyväinen' %}
    {% assign rating_good = 'Erittäin tyytyväinen' %}
    {% assign rating_excellent = 'Äärimmäisen tyytyväinen' %}
    {% assign rating_error = 'Valitse arviointisi' %}
    {% assign q2_title = section.settings.q2_title_fi | default: 'Kuvaile ratkaisematon kysymyksesi (vastaamme 24 tunnin sisällä arkipäivisin):' %}
    {% assign issue_error = 'Valitse ongelmatyyppi' %}
    {% assign submit_button = section.settings.submit_button_fi | default: 'Lähetä palaute' %}
    {% assign success_title = section.settings.success_title_fi | default: 'Palaute lähetetty onnistuneesti!' %}
    {% assign success_message = section.settings.success_message_fi | default: 'Kiitos arvokkaasta palautteestasi. Tarkastelemme ehdotuksesi huolellisesti.' %}
    {% assign close_button = 'Sulje' %}
  {% else %}
    {% comment %} Default English {% endcomment %}
    {% assign feedback_title = section.settings.feedback_title_en | default: 'Hepha.com Experience Feedback' %}
    {% assign feedback_subtitle = section.settings.feedback_subtitle_en | default: 'Your feedback is important to us and helps us improve our service quality.' %}
    {% assign close_label = 'Close feedback form' %}
    {% assign q1_label = section.settings.q1_label_en | default: 'How satisfied were you overall with Hepha.com?' %}
    {% assign rating_very_poor = 'Very dissatisfied' %}
    {% assign rating_poor = 'Somewhat dissatisfied' %}
    {% assign rating_average = 'Satisfied' %}
    {% assign rating_good = 'Very satisfied' %}
    {% assign rating_excellent = 'Extremely satisfied' %}
    {% assign rating_error = 'Please select your rating' %}
    {% assign q2_title = section.settings.q2_title_en | default: "Describe your unresolved question (we'll respond within 24h on weekdays):" %}
    {% assign issue_error = 'Please select an issue type' %}
    {% assign submit_button = section.settings.submit_button_en | default: 'Submit Feedback' %}
    {% assign success_title = section.settings.success_title_en | default: 'Feedback Submitted Successfully!' %}
    {% assign success_message = section.settings.success_message_en | default: 'Thank you for your valuable feedback. We will carefully review your suggestions.' %}
    {% assign close_button = 'Close' %}
{% endcase %}
<style>
  .feedback-button {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(45, 55, 72, 0.4);
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .feedback-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(45, 55, 72, 0.6);
    background: linear-gradient(135deg, #1a202c 0%, #171923 100%);
  }

  .feedback-button svg {
    width: 24px;
    height: 24px;
    fill: white;
  }

  .feedback-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.3s ease;
    padding: 20px;
    box-sizing: border-box;
  }

  .feedback-modal.show {
    display: flex;
  }

  .feedback-content {
    background: white;
    border-radius: 16px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    margin: 20px;
    animation: slideUp 0.3s ease;
    min-height: 400px;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .feedback-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
  }

  .feedback-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    padding-right: 40px;
  }

  .feedback-subtitle {
    font-size: 14px;
    color: #64748b;
    margin: 4px 0 0;
    line-height: 1.6;
  }

  .feedback-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #9ca3af;
    padding: 4px;
    line-height: 1;
  }

  .feedback-close:hover {
    color: #374151;
  }

  .feedback-body {
    padding: 24px;
  }

  /* Overall Experience Rating */
  .rating-section {
    margin-bottom: 24px;
  }

  .rating-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .rating-stars {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    justify-content: center;
    padding: 1rem;
    background: #ffffff;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
  }

  .rating-star {
    width: 40px;
    height: 40px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    background: none;
    padding: 0;
  }

  .rating-star:hover,
  .rating-star.selected {
    transform: scale(1.1);
  }

  .rating-star svg {
    width: 100%;
    height: 100%;
    fill: #d1d5db;
    transition: fill 0.3s ease;
  }

  .rating-star.selected svg,
  .rating-star:hover svg {
    fill: #fbbf24;
  }

  .rating-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
  }

  /*  Problem Report Panel */
  .problem-report {
    display: none;
    margin-top: 24px;
    padding: 20px;
    background: #f0f8ff;
    border-radius: 12px;
    border-left: 4px solid #3b82f6;
  }

  .problem-report.show {
    display: block;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .problem-title {
    font-size: 16px;
    font-weight: 700;
    color: #000000;
    margin: 0 0 16px;
  }

  .issue-types {
    display: grid;
    gap: 8px;
    margin-bottom: 20px;
  }

  .issue-type {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    color: #374151;
  }

  .issue-type:hover {
    border-color: #3b82f6;
    background: #f8fafc;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .issue-type.selected {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .issue-type input[type="radio"] {
    width: 18px;
    height: 18px;
    accent-color: #3b82f6;
    margin-right: 0.75rem;
    appearance: none;
    border: 2px solid #d1d5db;
    background: white;
    border-radius: 50%;
    position: relative;
    transition: all 0.3s ease;
  }

  .issue-type input[type="radio"]:checked {
    background: #3b82f6;
    border-color: #3b82f6;
  }

  .issue-type input[type="radio"]:checked::after {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .issue-type input[type="radio"]:hover {
    box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
  }

  .issue-type label {
    font-size: 14px;
    color: #374151;
    cursor: pointer;
    flex: 1;
    font-weight: 500;
  }

  /* Dynamic Sub-questions */
  .sub-questions {
    display: none;
    margin-top: 16px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
  }

  .sub-questions.show {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group:last-child {
    margin-bottom: 0;
  }

  .form-label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .form-label.required::after {
    content: " *";
    color: #dc2626;
    font-weight: bold;
    margin-left: 2px;
  }

  .form-input,
  .form-textarea,
  .form-select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    color: #1e293b;
    background: #ffffff;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    box-sizing: border-box;
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: #94a3b8;
    font-style: italic;
  }

  .form-textarea {
    resize: vertical;
    min-height: 120px;
    font-family: inherit;
  }

  .form-select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
    appearance: none;
  }

  /* Error Messages */
  .error-message {
    display: none;
    color: #dc2626;
    font-size: 12px;
    margin-top: 4px;
  }

  .error-message.show {
    display: block;
  }

  .form-group.error .form-input,
  .form-group.error .form-textarea,
  .form-group.error .form-select {
    border-color: #dc2626;
  }

  /* Submit Button */
  .feedback-submit {
    width: 100%;
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(45, 55, 72, 0.3);
    text-transform: capitalize;
    margin-top: 24px;
  }

  .feedback-submit:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(45, 55, 72, 0.4);
    background: linear-gradient(135deg, #1a202c 0%, #171923 100%);
  }

  .feedback-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .feedback-submit.loading {
    position: relative;
  }

  .feedback-submit.loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Success Message */
  .feedback-success {
    display: none;
    text-align: center;
    padding: 40px 24px;
  }

  .feedback-success.show {
    display: block;
  }

  .feedback-success-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 16px;
    background: #10b981;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .feedback-success-icon svg {
    width: 30px;
    height: 30px;
    fill: white;
  }

  .feedback-success-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px;
  }

  .feedback-success-message {
    font-size: 14px;
    color: #6b7280;
    margin: 0 0 24px;
  }

  .feedback-success-close {
    padding: 8px 16px;
    background: #f3f4f6;
    color: #374151;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .feedback-success-close:hover {
    background: #e5e7eb;
  }

  /* Mobile Responsive */
  @media (max-width: 640px) {
    .feedback-content {
      margin: 10px;
      max-width: none;
    }

    .feedback-header,
    .feedback-body {
      padding: 16px;
    }

    .rating-stars {
      justify-content: center;
    }

    .rating-star {
      width: 36px;
      height: 36px;
    }
  }
</style>

<!-- Feedback Button -->
<button class="feedback-button" id="feedbackBtn" aria-label="{{ close_label }}">
  <svg
    t="1750229384481"
    class="icon"
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    p-id="26690"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    width="200"
    height="200"
    aria-hidden="true"
  >
     <path d="M512 42.666667C252.8 42.666667 42.666667 252.8 42.666667 512c0 113.578667 40.362667 217.770667 107.52 298.922667L55.466667 981.333333H512c259.2 0 469.333333-210.133333 469.333333-469.333333S771.2 42.666667 512 42.666667zM355.541333 580.266667a170.709333 170.709333 0 0 0 312.96 0l17.066667-39.125334 78.208 34.176-17.066667 39.082667a256.042667 256.042667 0 0 1-469.376 0l-17.066666-39.082667 78.165333-34.133333 17.066667 39.082667z" p-id="26691" fill="#ffffff"></path>
    <circle cx="400" cy="400" r="40" fill="#000000" />
     <circle cx="624" cy="400" r="40" fill="#000000" />
  </svg>
</button>

<!-- Feedback Modal -->
<div class="feedback-modal" id="feedbackModal">
  <div class="feedback-content">
    <!-- Header -->
    <div class="feedback-header">
      <h2 class="feedback-title">{{ feedback_title }}</h2>
      <p class="feedback-subtitle">{{ feedback_subtitle }}</p>
      <button class="feedback-close" id="feedbackClose" aria-label="{{ close_label }}">&times;</button>
    </div>

    <!-- Form Container -->
    <div class="feedback-form-container" id="feedbackFormContainer">
      <div class="feedback-body">
        <!-- Shopify Contact Form -->
        <form action="{{ routes.root_url }}contact" method="post" id="feedbackForm" accept-charset="UTF-8" enctype="multipart/form-data">
          <input type="hidden" name="form_type" value="contact">
          <input type="hidden" name="utf8" value="✓">
          <input type="hidden" name="contact[name]" value="Website Feedback User">
          <input type="hidden" name="contact[email]" id="hiddenEmail">
          <input type="hidden" name="contact[body]" id="hiddenMessage">
          <input type="hidden" name="return_to" id="returnTo">

          <!-- Overall Experience Rating -->
          <div class="rating-section">
            <label class="rating-label">{{ q1_label }}</label>
            <div class="rating-stars" id="ratingStars">
              <button type="button" class="rating-star" data-rating="1" aria-label="1 star">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
              <button type="button" class="rating-star" data-rating="2" aria-label="2 stars">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
              <button type="button" class="rating-star" data-rating="3" aria-label="3 stars">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
              <button type="button" class="rating-star" data-rating="4" aria-label="4 stars">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
              <button type="button" class="rating-star" data-rating="5" aria-label="5 stars">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
            </div>
            {% comment %} <div class="rating-labels">
              <span>{{ rating_very_poor }}</span>
              <span>{{ rating_poor }}</span>
              <span>{{ rating_average }}</span>
              <span>{{ rating_good }}</span>
              <span>{{ rating_excellent }}</span>
            </div> {% endcomment %}
            <div class="error-message" id="ratingError">{{ rating_error }}</div>
          </div>

          <!--  Problem Report Panel (Conditional) -->
          <div class="problem-report" id="problemReport">
            <h3 class="problem-title">{{ q2_title }}</h3>
            
            <!-- Dynamic Issue Type Selection from Blocks -->
            <div class="issue-types" id="issueTypes">
              {% for block in section.blocks %}
                {% if block.type == 'issue_option' %}
                  {% case current_locale %}
                    {% when 'de' %}
                      {% assign issue_label = block.settings.issue_label_de %}
                    {% when 'fr' %}
                      {% assign issue_label = block.settings.issue_label_fr %}
                    {% when 'fi' %}
                      {% assign issue_label = block.settings.issue_label_fi %}
                    {% else %}
                      {% assign issue_label = block.settings.issue_label_en %}
                  {% endcase %}
                  
                  <div class="issue-type" data-issue="{{ block.settings.issue_value }}" {{ block.shopify_attributes }}>
                    <input type="radio" name="issue_type" value="{{ block.settings.issue_value }}" id="issue-{{ block.settings.issue_value }}">
                    <label for="issue-{{ block.settings.issue_value }}">{{ issue_label }}</label>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            <div class="error-message" id="issueTypeError">{{ issue_error }}</div>

            <!-- Dynamic Sub-questions -->
            <div class="sub-questions" id="subQuestions">
              <!-- Content will be dynamically loaded based on issue type -->
            </div>
          </div>

          <!-- Submit Button -->
          <button type="submit" class="feedback-submit" id="feedbackSubmit">{{ submit_button }}</button>
        </form>
      </div>
    </div>

    <!-- Success Message -->
    <div class="feedback-success" id="feedbackSuccess">
      <div class="feedback-success-icon">
        <svg viewBox="0 0 24 24">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
      </div>
      <h3 class="feedback-success-title">{{ success_title }}</h3>
      <p class="feedback-success-message">{{ success_message }}</p>
      <button class="feedback-success-close" id="feedbackSuccessClose">{{ close_button }}</button>
    </div>
  </div>
</div>

<script>
  // Multi-language support for JavaScript
  const translations = {
    'en': {
      ratingTexts: {
        1: 'Very dissatisfied',
        2: 'Somewhat dissatisfied', 
        3: 'Satisfied',
        4: 'Very satisfied',
        5: 'Extremely satisfied'
      },
      issueTexts: {
        'page-loading-slow': 'Page loading speed issues',
        'search-functionality': 'Search function not working properly',
        'incomplete-product-info': 'Incomplete or inaccurate product information',
        'mobile-experience': 'Mobile device experience issues',
        'checkout-payment': 'Checkout or payment process issues',
        'live-chat-failed': 'Online customer service failure',
        'find-local-dealer': 'Dealer location information issues',
        'technical-bug': 'Website technical issues',
        'navigation-issues': 'Website navigation or layout issues',
        'browser-compatibility': 'Browser compatibility issues',
        'other-issues': 'Other issues not listed above'
      },
      subQuestionTemplates: {
        'page-loading-slow': `
          <div class="form-group">
            <label class="form-label required">Which pages were loading slowly?</label>
            <textarea class="form-textarea" name="slow_pages" placeholder="Example: Product pages, checkout page" required></textarea>
            <div class="error-message" id="slowPagesError">Please describe which pages were slow</div>
          </div>
          <div class="form-group">
            <label class="form-label">What device/browser were you using?</label>
            <input type="text" class="form-input" name="device_browser" placeholder="Example: iPhone Safari, Chrome on Windows">
          </div>
        `,
        'incomplete-product-info': `
          <div class="form-group">
            <label class="form-label required">Which product page had issues?</label>
            <input type="url" class="form-input" name="product_url" placeholder="Product page URL" required>
            <div class="error-message" id="productUrlError">Please enter the product page URL</div>
          </div>
          <div class="form-group">
            <label class="form-label required">What information was missing or incorrect?</label>
            <textarea class="form-textarea" name="missing_info" placeholder="Example: Missing battery specifications" required></textarea>
            <div class="error-message" id="missingInfoError">Please describe what information was missing</div>
          </div>
          <div class="form-group">
            <label class="form-label">Optional follow-up:</label>
            <input type="email" class="form-input" name="followup_email" placeholder="We may contact you for clarification (if needed)">
          </div>
        `,
        'live-chat-failed': `
          <div class="form-group">
            <label class="form-label required">Describe your unresolved question (we'll respond within 24h on weekdays):</label>
            <textarea class="form-textarea" name="unresolved_question" placeholder="Example: Payment failed but order deducted funds" required></textarea>
            <div class="error-message" id="unresolvedQuestionError">Please describe your unresolved question</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Required contact:</label>
            <input type="email" class="form-input" name="contact_email" placeholder="Email for follow-up" required>
            <div class="error-message" id="contactEmailError">Please enter a valid email address</div>
          </div>
        `,
        'find-local-dealer': `
          <div class="form-group">
            <label class="form-label required">Describe your unresolved question (we'll respond within 24h on weekdays):</label>
            <textarea class="form-textarea" name="dealer_question" placeholder="Describe your dealer-related question" required></textarea>
            <div class="error-message" id="dealerQuestionError">Please describe your question</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Required contact:</label>
            <input type="email" class="form-input" name="dealer_email" placeholder="Email for follow-up" required>
            <div class="error-message" id="dealerEmailError">Please enter a valid email address</div>
          </div>
        `,
        'technical-bug': `
          <div class="form-group">
            <label class="form-label required">Describe your unresolved question (we'll respond within 24h on weekdays):</label>
            <textarea class="form-textarea" name="technical_description" placeholder="Describe the technical issue" required></textarea>
            <div class="error-message" id="technicalDescriptionError">Please describe the technical issue</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Required contact:</label>
            <input type="email" class="form-input" name="technical_email" placeholder="Email for follow-up" required>
            <div class="error-message" id="technicalEmailError">Please enter a valid email address</div>
          </div>
        `,
        'navigation-issues': `
          <div class="form-group">
            <label class="form-label required">Where did you face difficulties?</label>
            <textarea class="form-textarea" name="navigation_difficulties" placeholder="Example: Menu structure unclear on mobile" required></textarea>
            <div class="error-message" id="navigationDifficultiesError">Please describe where you faced difficulties</div>
          </div>
        `,
        'other-issues': `
          <div class="form-group">
            <label class="form-label required">Please describe your issue:</label>
            <textarea class="form-textarea" name="other_description" placeholder="Describe the issue you encountered" required></textarea>
            <div class="error-message" id="otherDescriptionError">Please describe your issue</div>
          </div>
          <div class="form-group">
            <label class="form-label">Contact email (optional):</label>
            <input type="email" class="form-input" name="other_email" placeholder="Email for follow-up if needed">
          </div>
        `
      }
    },
    'de': {
      ratingTexts: {
        1: 'Sehr unzufrieden',
        2: 'Eher unzufrieden', 
        3: 'Zufrieden',
        4: 'Sehr zufrieden',
        5: 'Äußerst zufrieden'
      },
      issueTexts: {
        'page-loading-slow': 'Probleme mit der Seitenladegeschwindigkeit',
        'search-functionality': 'Suchfunktion funktioniert nicht ordnungsgemäß',
        'incomplete-product-info': 'Unvollständige oder fehlerhafte Produktinformationen',
        'mobile-experience': 'Probleme mit der mobilen Geräteerfahrung',
        'checkout-payment': 'Probleme beim Checkout- oder Zahlungsvorgang',
        'live-chat-failed': 'Der Live Chat war nicht erreichbar',
        'find-local-dealer': 'Probleme mit Händlerstandort-Informationen',
        'technical-bug': 'Website-technische Probleme',
        'navigation-issues': 'Schwierigkeiten bei der Navigation oder Bedienung der Website',
        'browser-compatibility': 'Browser-Kompatibilitätsprobleme',
        'other-issues': 'Sonstige Probleme'
      },
      subQuestionTemplates: {
        'incomplete-product-info': `
          <div class="form-group">
            <label class="form-label required">Welche Produktseite hatte Probleme?</label>
            <input type="url" class="form-input" name="product_url" placeholder="Produktseiten-URL" required>
            <div class="error-message" id="productUrlError">Bitte geben Sie die Produktseiten-URL ein</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Welche Informationen fehlten oder waren falsch?</label>
            <textarea class="form-textarea" name="missing_info" placeholder="Beispiel: Fehlende Batteriespezifikationen" required></textarea>
            <div class="error-message" id="missingInfoError">Bitte beschreiben Sie, welche Informationen fehlten</div>
          </div>
          <div class="form-group">
            <label class="form-label">Optionale Nachfrage:</label>
            <input type="email" class="form-input" name="followup_email" placeholder="Wir können Sie zur Klärung kontaktieren (kein Marketing)">
          </div>
        `,
        'live-chat-failed': `
          <div class="form-group">
            <label class="form-label required">Beschreiben Sie Ihre ungelöste Frage (wir antworten innerhalb von 24h):</label>
            <textarea class="form-textarea" name="unresolved_question" placeholder="Beispiel: Zahlung fehlgeschlagen, aber Bestellung hat Geld abgebucht" required></textarea>
            <div class="error-message" id="unresolvedQuestionError">Bitte beschreiben Sie Ihre ungelöste Frage</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Erforderlicher Kontakt:</label>
            <input type="email" class="form-input" name="contact_email" placeholder="E-Mail für Nachfragen" required>
            <div class="error-message" id="contactEmailError">Bitte geben Sie eine gültige E-Mail-Adresse ein</div>
          </div>
        `,
        'find-local-dealer': `
          <div class="form-group">
            <label class="form-label required">Beschreiben Sie Ihre ungelöste Frage (wir antworten innerhalb von 24h):</label>
            <textarea class="form-textarea" name="dealer_question" placeholder="Beschreiben Sie Ihre händlerbezogene Frage" required></textarea>
            <div class="error-message" id="dealerQuestionError">Bitte beschreiben Sie Ihre Frage</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Erforderlicher Kontakt:</label>
            <input type="email" class="form-input" name="dealer_email" placeholder="E-Mail für Nachfragen" required>
            <div class="error-message" id="dealerEmailError">Bitte geben Sie eine gültige E-Mail-Adresse ein</div>
          </div>
        `,
        'technical-bug': `
          <div class="form-group">
            <label class="form-label required">Beschreiben Sie Ihre ungelöste Frage (wir antworten innerhalb von 24h):</label>
            <textarea class="form-textarea" name="technical_description" placeholder="Beschreiben Sie das technische Problem" required></textarea>
            <div class="error-message" id="technicalDescriptionError">Bitte beschreiben Sie das technische Problem</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Erforderlicher Kontakt:</label>
            <input type="email" class="form-input" name="technical_email" placeholder="E-Mail für Nachfragen" required>
            <div class="error-message" id="technicalEmailError">Bitte geben Sie eine gültige E-Mail-Adresse ein</div>
          </div>
        `,
        'navigation-issues': `
          <div class="form-group">
            <label class="form-label required">Wo hatten Sie Schwierigkeiten?</label>
            <textarea class="form-textarea" name="navigation_difficulties" placeholder="Beispiel: Menüstruktur auf Mobilgeräten unklar" required></textarea>
            <div class="error-message" id="navigationDifficultiesError">Bitte beschreiben Sie, wo Sie Schwierigkeiten hatten</div>
          </div>
        `,
        'browser-compatibility': `
          <div class="form-group">
            <label class="form-label required">Welchen Browser haben Sie verwendet?</label>
            <input type="text" class="form-input" name="browser_info" placeholder="Beispiel: Internet Explorer 11, Safari 14" required>
            <div class="error-message" id="browserInfoError">Bitte geben Sie Ihren Browser an</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Was hat nicht richtig funktioniert?</label>
            <textarea class="form-textarea" name="browser_issues" placeholder="Beispiel: Schaltflächen nicht anklickbar, Layout defekt" required></textarea>
            <div class="error-message" id="browserIssuesError">Bitte beschreiben Sie die Browser-Probleme</div>
          </div>
        `,
        'other-issues': `
          <div class="form-group">
            <label class="form-label required">Bitte beschreiben Sie Ihr Problem:</label>
            <textarea class="form-textarea" name="other_description" placeholder="Beschreiben Sie das Problem, das Sie hatten" required></textarea>
            <div class="error-message" id="otherDescriptionError">Bitte beschreiben Sie Ihr Problem</div>
          </div>
          <div class="form-group">
            <label class="form-label">Kontakt-E-Mail (optional):</label>
            <input type="email" class="form-input" name="other_email" placeholder="E-Mail für Nachfragen falls nötig">
          </div>
        `
      }
    },
    'fr': {
      ratingTexts: {
        1: 'Très insatisfait',
        2: 'Quelque peu insatisfait', 
        3: 'Satisfait',
        4: 'Très satisfait',
        5: 'Extrêmement satisfait'
      },
      issueTexts: {
        'page-loading-slow': 'Problèmes de vitesse de chargement des pages',
        'search-functionality': 'Fonction de recherche ne fonctionne pas correctement',
        'incomplete-product-info': 'Informations produit incomplètes ou inexactes',
        'mobile-experience': 'Problèmes d\'expérience sur appareil mobile',
        'checkout-payment': 'Problèmes de processus de commande ou de paiement',
        'live-chat-failed': 'Échec du service client en ligne',
        'find-local-dealer': 'Problèmes d\'informations de localisation des revendeurs',
        'navigation-issues': 'Problèmes de navigation ou de mise en page du site web',
        'browser-compatibility': 'Problèmes de compatibilité du navigateur',
        'other-issues': 'Autres problèmes non listés ci-dessus'
      },
      subQuestionTemplates: {
        'incomplete-product-info': `
          <div class="form-group">
            <label class="form-label required">Quelle page produit avait des problèmes?</label>
            <input type="url" class="form-input" name="product_url" placeholder="URL de la page produit" required>
            <div class="error-message" id="productUrlError">Veuillez saisir l'URL de la page produit</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Quelles informations manquaient ou étaient incorrectes?</label>
            <textarea class="form-textarea" name="missing_info" placeholder="Exemple: Spécifications de batterie manquantes" required></textarea>
            <div class="error-message" id="missingInfoError">Veuillez décrire quelles informations manquaient</div>
          </div>
          <div class="form-group">
            <label class="form-label">Suivi optionnel:</label>
            <input type="email" class="form-input" name="followup_email" placeholder="Nous pouvons vous contacter pour clarification (pas de marketing)">
          </div>
        `,
        'live-chat-failed': `
          <div class="form-group">
            <label class="form-label required">Décrivez votre question non résolue (nous répondrons dans les 24h):</label>
            <textarea class="form-textarea" name="unresolved_question" placeholder="Exemple: Paiement échoué mais commande a débité les fonds" required></textarea>
            <div class="error-message" id="unresolvedQuestionError">Veuillez décrire votre question non résolue</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Contact requis:</label>
            <input type="email" class="form-input" name="contact_email" placeholder="Email pour le suivi" required>
            <div class="error-message" id="contactEmailError">Veuillez saisir une adresse email valide</div>
          </div>
        `,
        'find-local-dealer': `
          <div class="form-group">
            <label class="form-label required">Décrivez votre question non résolue (nous répondrons dans les 24h):</label>
            <textarea class="form-textarea" name="dealer_question" placeholder="Décrivez votre question liée au revendeur" required></textarea>
            <div class="error-message" id="dealerQuestionError">Veuillez décrire votre question</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Contact requis:</label>
            <input type="email" class="form-input" name="dealer_email" placeholder="Email pour le suivi" required>
            <div class="error-message" id="dealerEmailError">Veuillez saisir une adresse email valide</div>
          </div>
        `,
        'technical-bug': `
          <div class="form-group">
            <label class="form-label required">Décrivez votre question non résolue (nous répondrons dans les 24h):</label>
            <textarea class="form-textarea" name="technical_description" placeholder="Décrivez le problème technique" required></textarea>
            <div class="error-message" id="technicalDescriptionError">Veuillez décrire le problème technique</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Contact requis:</label>
            <input type="email" class="form-input" name="technical_email" placeholder="Email pour le suivi" required>
            <div class="error-message" id="technicalEmailError">Veuillez saisir une adresse email valide</div>
          </div>
        `,
        'navigation-issues': `
          <div class="form-group">
            <label class="form-label required">Où avez-vous rencontré des difficultés?</label>
            <textarea class="form-textarea" name="navigation_difficulties" placeholder="Exemple: Structure de menu peu claire sur mobile" required></textarea>
            <div class="error-message" id="navigationDifficultiesError">Veuillez décrire où vous avez rencontré des difficultés</div>
          </div>
        `,
        'browser-compatibility': `
          <div class="form-group">
            <label class="form-label required">Quel navigateur utilisiez-vous?</label>
            <input type="text" class="form-input" name="browser_info" placeholder="Exemple: Internet Explorer 11, Safari 14" required>
            <div class="error-message" id="browserInfoError">Veuillez spécifier votre navigateur</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Qu'est-ce qui ne fonctionnait pas correctement?</label>
            <textarea class="form-textarea" name="browser_issues" placeholder="Exemple: Boutons non cliquables, mise en page cassée" required></textarea>
            <div class="error-message" id="browserIssuesError">Veuillez décrire les problèmes de navigateur</div>
          </div>
        `,
        'other-issues': `
          <div class="form-group">
            <label class="form-label required">Veuillez décrire votre problème:</label>
            <textarea class="form-textarea" name="other_description" placeholder="Décrivez le problème que vous avez rencontré" required></textarea>
            <div class="error-message" id="otherDescriptionError">Veuillez décrire votre problème</div>
          </div>
          <div class="form-group">
            <label class="form-label">Email de contact (optionnel):</label>
            <input type="email" class="form-input" name="other_email" placeholder="Email pour suivi si nécessaire">
          </div>
        `
      }
    },
    'fi': {
      ratingTexts: {
        1: 'Erittäin tyytymätön',
        2: 'Jonkin verran tyytymätön', 
        3: 'Tyytyväinen',
        4: 'Erittäin tyytyväinen',
        5: 'Äärimmäisen tyytyväinen'
      },
      issueTexts: {
        'page-loading-slow': 'Sivun latausnopeuden ongelmat',
        'search-functionality': 'Hakutoiminto ei toimi kunnolla',
        'incomplete-product-info': 'Puutteelliset tai virheelliset tuotetiedot',
        'mobile-experience': 'Mobiililaitteen käyttökokemuksen ongelmat',
        'checkout-payment': 'Kassaprosessin tai maksun ongelmat',
        'live-chat-failed': 'Live chat ei ollut käytettävissä',
        'find-local-dealer': 'Jälleenmyyjän sijaintitietojen ongelmat',
        'navigation-issues': 'Verkkosivuston navigointi- tai asetteluongelmat',
        'browser-compatibility': 'Selaimen yhteensopivuusongelmat',
        'other-issues': 'Muut yllä luetteloimattomat ongelmat'
      },
      subQuestionTemplates: {
        'incomplete-product-info': `
          <div class="form-group">
            <label class="form-label required">Millä tuotesivulla oli ongelmia?</label>
            <input type="url" class="form-input" name="product_url" placeholder="Tuotesivun URL" required>
            <div class="error-message" id="productUrlError">Anna tuotesivun URL</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Mitä tietoja puuttui tai oli väärin?</label>
            <textarea class="form-textarea" name="missing_info" placeholder="Esimerkki: Puuttuvat akkutiedot" required></textarea>
            <div class="error-message" id="missingInfoError">Kuvaile mitä tietoja puuttui</div>
          </div>
          <div class="form-group">
            <label class="form-label">Valinnainen seuranta:</label>
            <input type="email" class="form-input" name="followup_email" placeholder="Voimme ottaa yhteyttä selvennystä varten (ei markkinointia)">
          </div>
        `,
        'live-chat-failed': `
          <div class="form-group">
            <label class="form-label required">Kuvaile ratkaisematon kysymyksesi (vastaamme 24 tunnin sisällä arkipäivisin):</label>
            <textarea class="form-textarea" name="unresolved_question" placeholder="Esimerkki: Maksu epäonnistui mutta tilaus veloitti varat" required></textarea>
            <div class="error-message" id="unresolvedQuestionError">Kuvaile ratkaisematon kysymyksesi</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Pakollinen yhteystieto:</label>
            <input type="email" class="form-input" name="contact_email" placeholder="Sähköposti seurantaa varten" required>
            <div class="error-message" id="contactEmailError">Anna kelvollinen sähköpostiosoite</div>
          </div>
        `,
        'find-local-dealer': `
          <div class="form-group">
            <label class="form-label required">Kuvaile ratkaisematon kysymyksesi (vastaamme 24 tunnin sisällä arkipäivisin):</label>
            <textarea class="form-textarea" name="dealer_question" placeholder="Kuvaile jälleenmyyjään liittyvä kysymyksesi" required></textarea>
            <div class="error-message" id="dealerQuestionError">Kuvaile kysymyksesi</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Pakollinen yhteystieto:</label>
            <input type="email" class="form-input" name="dealer_email" placeholder="Sähköposti seurantaa varten" required>
            <div class="error-message" id="dealerEmailError">Anna kelvollinen sähköpostiosoite</div>
          </div>
        `,
        'technical-bug': `
          <div class="form-group">
            <label class="form-label required">Kuvaile ratkaisematon kysymyksesi (vastaamme 24 tunnin sisällä arkipäivisin):</label>
            <textarea class="form-textarea" name="technical_description" placeholder="Kuvaile tekninen ongelma" required></textarea>
            <div class="error-message" id="technicalDescriptionError">Kuvaile tekninen ongelma</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Pakollinen yhteystieto:</label>
            <input type="email" class="form-input" name="technical_email" placeholder="Sähköposti seurantaa varten" required>
            <div class="error-message" id="technicalEmailError">Anna kelvollinen sähköpostiosoite</div>
          </div>
        `,
        'navigation-issues': `
          <div class="form-group">
            <label class="form-label required">Missä kohtasit vaikeuksia?</label>
            <textarea class="form-textarea" name="navigation_difficulties" placeholder="Esimerkki: Valikon rakenne epäselvä mobiilissa" required></textarea>
            <div class="error-message" id="navigationDifficultiesError">Kuvaile missä kohtasit vaikeuksia</div>
          </div>
        `,
        'browser-compatibility': `
          <div class="form-group">
            <label class="form-label required">Mitä selainta käytit?</label>
            <input type="text" class="form-input" name="browser_info" placeholder="Esimerkki: Internet Explorer 11, Safari 14" required>
            <div class="error-message" id="browserInfoError">Määritä selaimesi</div>
          </div>
          <div class="form-group">
            <label class="form-label required">Mikä ei toiminut kunnolla?</label>
            <textarea class="form-textarea" name="browser_issues" placeholder="Esimerkki: Painikkeet eivät olleet klikattavia, asettelu rikki" required></textarea>
            <div class="error-message" id="browserIssuesError">Kuvaile selaimen ongelmat</div>
          </div>
        `,
        'other-issues': `
          <div class="form-group">
            <label class="form-label required">Kuvaile ongelmasi:</label>
            <textarea class="form-textarea" name="other_description" placeholder="Kuvaile kohtaamasi ongelma" required></textarea>
            <div class="error-message" id="otherDescriptionError">Kuvaile ongelmasi</div>
          </div>
          <div class="form-group">
            <label class="form-label">Yhteyssähköposti (valinnainen):</label>
            <input type="email" class="form-input" name="other_email" placeholder="Sähköposti seurantaa varten tarvittaessa">
          </div>
        `
      }
    }
  };

  // Get current locale from Shopify
  const currentLocale = '{{ request.locale.iso_code }}' || 'en';
  const currentTranslations = translations[currentLocale] || translations['en'];

  const FeedbackModal = {
    // Initialize the feedback modal
    init() {
      this.modal = document.getElementById('feedbackModal');
      this.feedbackBtn = document.getElementById('feedbackBtn');
      this.closeBtn = document.getElementById('feedbackClose');
      this.form = document.getElementById('feedbackForm');
      this.formContainer = document.getElementById('feedbackFormContainer');
      this.successMessage = document.getElementById('feedbackSuccess');
      this.successCloseBtn = document.getElementById('feedbackSuccessClose');
      this.submitBtn = document.getElementById('feedbackSubmit');
      this.ratingStars = document.getElementById('ratingStars');
      this.problemReport = document.getElementById('problemReport');
      this.issueTypes = document.getElementById('issueTypes');
      this.subQuestions = document.getElementById('subQuestions');
      
      this.selectedRating = 0;
      this.selectedIssueType = '';
      
      this.bindEvents();
      this.checkSubmissionStatus();
    },

    // Bind event listeners
    bindEvents() {
      if (this.feedbackBtn) {
        this.feedbackBtn.addEventListener('click', () => this.open());
      }

      if (this.closeBtn) {
        this.closeBtn.addEventListener('click', () => this.close());
      }

      if (this.successCloseBtn) {
        this.successCloseBtn.addEventListener('click', () => this.close());
      }

      if (this.modal) {
        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) {
            this.close();
          }
        });
      }

      if (this.form) {
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
      }

      // Rating stars
      if (this.ratingStars) {
        this.ratingStars.addEventListener('click', (e) => {
          if (e.target.closest('.rating-star')) {
            const rating = parseInt(e.target.closest('.rating-star').dataset.rating);
            this.selectRating(rating);
          }
        });
      }

      // Issue type selection
      if (this.issueTypes) {
        this.issueTypes.addEventListener('change', (e) => {
          if (e.target.name === 'issue_type') {
            this.selectIssueType(e.target.value);
          }
        });
      }
    },

    // Open modal
    open() {
      if (this.modal) {
        this.modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Focus first interactive element
        setTimeout(() => {
          const firstStar = this.ratingStars?.querySelector('.rating-star');
          if (firstStar) {
            firstStar.focus();
          }
        }, 100);
      }
    },

    // Close modal
    close() {
      if (this.modal) {
        this.modal.classList.remove('show');
        document.body.style.overflow = '';
        this.resetForm();
      }
    },

    // Select rating
    selectRating(rating) {
      this.selectedRating = rating;
      this.clearError('ratingError');
      
      // Update star display
      const stars = this.ratingStars.querySelectorAll('.rating-star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('selected');
        } else {
          star.classList.remove('selected');
        }
      });
      
      // Show/hide problem report based on rating
      if (rating <= 3) {
        this.problemReport.classList.add('show');
      } else {
        this.problemReport.classList.remove('show');
        this.selectedIssueType = '';
        this.subQuestions.classList.remove('show');
      }
    },

    // Select issue type
    selectIssueType(issueType) {
      this.selectedIssueType = issueType;
      this.clearError('issueTypeError');
      
      // Update issue type display
      const issueElements = this.issueTypes.querySelectorAll('.issue-type');
      issueElements.forEach(element => {
        if (element.dataset.issue === issueType) {
          element.classList.add('selected');
        } else {
          element.classList.remove('selected');
        }
      });
      
      // Load sub-questions
      this.loadSubQuestions(issueType);
    },

    // Load dynamic sub-questions based on issue type
    loadSubQuestions(issueType) {
      const subQuestionTemplates = currentTranslations.subQuestionTemplates;
      
      if (subQuestionTemplates[issueType]) {
        this.subQuestions.innerHTML = subQuestionTemplates[issueType];
        this.subQuestions.classList.add('show');
      } else {
        this.subQuestions.classList.remove('show');
      }
    },

    // Handle form submission
    handleSubmit(e) {
      e.preventDefault();
      
      if (!this.validateForm()) {
        return;
      }
      
      this.setLoadingState(true);
      this.prepareFormData();
      
      // Submit the form
      setTimeout(() => {
        this.form.submit();
      }, 100);
    },

    // Validate form
    validateForm() {
      let isValid = true;
      
      // Clear all errors
      this.clearAllErrors();
      
      // Validate rating
      if (this.selectedRating === 0) {
        this.showError('ratingError');
        isValid = false;
      }
      
      // If rating <= 3, validate issue type and sub-questions
      if (this.selectedRating <= 3 && this.selectedRating > 0) {
        if (!this.selectedIssueType) {
          this.showError('issueTypeError');
          isValid = false;
        } else {
          // Validate sub-question required fields
          const requiredFields = this.subQuestions.querySelectorAll('[required]');
          requiredFields.forEach(field => {
            if (!field.value.trim()) {
              const errorId = field.name.replace('_', '') + 'Error';
              this.showError(errorId);
              field.closest('.form-group')?.classList.add('error');
              isValid = false;
            }
          });
          
          // Validate email format
          const emailFields = this.subQuestions.querySelectorAll('input[type="email"]');
          emailFields.forEach(field => {
            if (field.hasAttribute('required') && field.value && !this.isValidEmail(field.value)) {
              this.showError('emailError');
              field.closest('.form-group')?.classList.add('error');
              isValid = false;
            }
          });
        }
      }
      
      return isValid;
    },

    // Check if email is valid
    isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    },

    // Prepare form data for Shopify submission
    prepareFormData() {
      const hiddenEmail = document.getElementById('hiddenEmail');
      const hiddenMessage = document.getElementById('hiddenMessage');
      const returnTo = document.getElementById('returnTo');
      
      // Get user email
      let userEmail = 'anonymous@hepha.com';
      const emailField = this.subQuestions.querySelector('input[name="user_email"]');
      if (emailField && emailField.value) {
        userEmail = emailField.value;
      }
      
      // Build comprehensive message
      let message = this.buildComprehensiveMessage();
      
      // Set hidden fields
      if (hiddenEmail) hiddenEmail.value = userEmail;
      if (hiddenMessage) hiddenMessage.value = message;
      if (returnTo) returnTo.value = window.location.pathname + '?contact_posted=true' + window.location.hash;
    },

    // Build comprehensive message for email
    buildComprehensiveMessage() {
      const timestamp = new Date().toLocaleString('en-US');
      const currentUrl = window.location.href;
      const ratingText = this.getRatingText(this.selectedRating);
      
      let message = `=== Hepha.com Experience Feedback ===\n\n`;
      message += `Submission Time: ${timestamp}\n`;
      message += `Page URL: ${currentUrl}\n\n`;
      
      message += `Overall Experience Rating\n`;
      message += `Rating: ${this.selectedRating}/5 (${ratingText})\n\n`;
      
      if (this.selectedRating <= 3 && this.selectedIssueType) {
        message += ` Problem Report\n`;
        message += `Issue Type: ${this.getIssueTypeText(this.selectedIssueType)}\n\n`;
        
        // Add sub-question data
        const formData = new FormData();
        const inputs = this.subQuestions.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          if (input.value) {
            const label = this.getFieldLabel(input.name);
            message += `${label}: ${input.value}\n`;
          }
        });
      }
      
      message += `\n---\nThis email was automatically sent by the Hepha.com feedback system`;
      
      return message;
    },

    // Get rating text
    getRatingText(rating) {
      return currentTranslations.ratingTexts[rating] || 'Unknown';
    },

    // Get issue type text
    getIssueTypeText(issueType) {
      return currentTranslations.issueTexts[issueType] || issueType;
    },

    // Get field label
    getFieldLabel(fieldName) {
      const fieldLabels = {
        'missing_info': 'Missing Information Details',
        'followup_email': 'Follow-up Email',
        'unresolved_question': 'Unresolved Question',
        'contact_email': 'Contact Email',
        'dealer_question': 'Dealer Question',
        'dealer_email': 'Dealer Email',
        'technical_description': 'Technical Issue Description',
        'technical_email': 'Technical Email',
        'navigation_difficulties': 'Navigation Difficulties'
      };
      return fieldLabels[fieldName] || fieldName;
    },

    // Check submission status
    checkSubmissionStatus() {
      // Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('contact_posted') === 'true') {
        this.showSuccess();
        this.open();
        return;
      }
      
      // Check local storage
      if (localStorage.getItem('feedback_submitted') === 'true') {
        localStorage.removeItem('feedback_submitted');
        this.showSuccess();
        this.open();
        return;
      }
      
      // Check for Shopify success message
      const shopifySuccess = document.querySelector('.shopify-section--contact-form .form-success');
      if (shopifySuccess && shopifySuccess.style.display !== 'none') {
        this.showSuccess();
        this.open();
      }
    },

    // Show error message
    showError(errorId) {
      const errorElement = document.getElementById(errorId);
      if (errorElement) {
        errorElement.classList.add('show');
      }
    },

    // Clear error message
    clearError(errorId) {
      const errorElement = document.getElementById(errorId);
      if (errorElement) {
        errorElement.classList.remove('show');
      }
    },

    // Clear all error messages
    clearAllErrors() {
      const errorElements = document.querySelectorAll('.error-message.show');
      errorElements.forEach(element => {
        element.classList.remove('show');
      });
      
      const errorGroups = document.querySelectorAll('.form-group.error');
      errorGroups.forEach(group => {
        group.classList.remove('error');
      });
    },

    // Set loading state
    setLoadingState(isLoading) {
      if (this.submitBtn) {
        this.submitBtn.disabled = isLoading;
        
        if (isLoading) {
          this.submitBtn.classList.add('loading');
          this.submitBtn.textContent = 'Submitting...';
        } else {
          this.submitBtn.classList.remove('loading');
          this.submitBtn.textContent = 'Submit Feedback';
        }
      }
    },

    // Show success message
    showSuccess() {
      if (this.successMessage && this.formContainer) {
        this.successMessage.classList.add('show');
        this.formContainer.style.display = 'none';
        
        setTimeout(() => {
          const closeBtn = this.successMessage.querySelector('.feedback-success-close');
          if (closeBtn) {
            closeBtn.focus();
          }
        }, 100);
      }
    },

    // Reset form
    resetForm() {
      if (this.form) {
        this.form.reset();
        this.clearAllErrors();
      }
      
      this.selectedRating = 0;
      this.selectedIssueType = '';
      
      // Reset UI state
      const stars = this.ratingStars?.querySelectorAll('.rating-star');
      if (stars) {
        stars.forEach(star => star.classList.remove('selected'));
      }
      
      const issueElements = this.issueTypes?.querySelectorAll('.issue-type');
      if (issueElements) {
        issueElements.forEach(element => element.classList.remove('selected'));
      }
      
      if (this.problemReport) {
        this.problemReport.classList.remove('show');
      }
      
      if (this.subQuestions) {
        this.subQuestions.classList.remove('show');
        this.subQuestions.innerHTML = '';
      }
      
      if (this.successMessage && this.formContainer) {
        this.successMessage.classList.remove('show');
        this.formContainer.style.display = 'block';
      }
      
      this.setLoadingState(false);
    }
  };

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    FeedbackModal.init();
  });

  // Export to global scope
  window.FeedbackModal = FeedbackModal;
</script>