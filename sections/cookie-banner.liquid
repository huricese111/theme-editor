{% liquid
  assign lang = request.locale.iso_code
  assign privacy_url = section.settings.privacy_policy_url | default: '/policies/privacy-policy'
  assign cookie_url = section.settings.cookie_policy_url | default: '/pages/privacy-policy'
  assign first_char_p = privacy_url | slice: 0, 1
  assign proto_rel_p = privacy_url | slice: 0, 2
  if privacy_url contains '://' or proto_rel_p == '//'
  elsif first_char_p != '/'
    assign privacy_url = '/' | append: privacy_url
  endif
  assign first_char_c = cookie_url | slice: 0, 1
  assign proto_rel_c = cookie_url | slice: 0, 2
  if cookie_url contains '://' or proto_rel_c == '//'
  elsif first_char_c != '/'
    assign cookie_url = '/' | append: cookie_url
  endif
  case lang
    when 'de'
      assign banner_title = 'Wir respektieren Ihre Privatsphäre'
      assign banner_desc = 'Wir verwenden Cookies für grundlegende Funktionen, Leistungsanalyse und personalisierte Inhalte. Sie können alle akzeptieren, alle ablehnen oder Ihre Präferenzen festlegen.'
      assign accept_label = 'Alle akzeptieren'
      assign deny_label = 'Alle ablehnen'
      assign pref_label = 'Einstellungen'
      assign manage_label = 'Cookie verwalten'
      assign privacy_label = 'Datenschutzerklärung'
      assign cookie_label = 'Cookie-Richtlinie'
      assign save_label = 'Speichern'
      assign func_label = 'Funktionalität'
      assign perf_label = 'Leistung'
      assign targ_label = 'Targeting'
      assign modal_desc = 'Wähle, welche Arten von Cookies zulässig sind. Du kannst dies jederzeit ändern.'
      assign func_desc = 'Essenzielle Cookies ermöglichen grundlegende Funktionen (Sicherheit, Netzwerkverwaltung, Barrierefreiheit) und merken Einstellungen wie Sprache und Region. Diese können nicht deaktiviert werden.'
      assign perf_desc = 'Analyse-Cookies sammeln aggregierte Nutzungsdaten, um Traffic zu messen, Fehler zu erkennen und Geschwindigkeit sowie Benutzerfreundlichkeit zu verbessern. Daten werden ausschließlich zur Leistungsoptimierung verwendet.'
      assign targ_desc = 'Marketing-Cookies personalisieren Inhalte und Werbung und messen die Wirksamkeit von Kampagnen über Partner und Plattformen. Dabei können Drittanbieter beteiligt sein.'
    when 'fr'
      assign banner_title = 'Nous respectons votre vie privée'
      assign banner_desc = 'Nous utilisons des cookies pour la fonctionnalité, la performance et le ciblage. Vous pouvez tout accepter, tout refuser ou choisir vos préférences.'
      assign accept_label = 'Tout accepter'
      assign deny_label = 'Tout refuser'
      assign pref_label = 'Préférences'
      assign manage_label = 'Gérer les cookies'
      assign privacy_label = 'Politique de confidentialité'
      assign cookie_label = 'Politique de cookies'
      assign save_label = 'Enregistrer'
      assign func_label = 'Fonctionnalité'
      assign perf_label = 'Performance'
      assign targ_label = 'Ciblage'
      assign modal_desc = 'Choisissez les types de cookies autorisés. Vous pouvez modifier à tout moment.'
      assign func_desc = 'Les cookies essentiels permettent les fonctions de base du site (sécurité, gestion du réseau, accessibilité) et mémorisent vos paramètres (langue, région). Ils ne peuvent pas être désactivés.'
      assign perf_desc = 'Les cookies d’analyse collectent des données agrégées pour mesurer l’audience, détecter les erreurs et améliorer la rapidité et l’ergonomie. Les données sont utilisées uniquement pour l’optimisation des performances.'
      assign targ_desc = 'Les cookies marketing personnalisent le contenu et la publicité et mesurent l’efficacité des campagnes sur différents partenaires et plateformes. Des fournisseurs tiers peuvent être impliqués.'
    when 'fi'
      assign banner_title = 'Kunnioitamme yksityisyyttäsi'
      assign banner_desc = 'Käytämme evästeitä toiminnallisuuteen, suorituskykyyn ja kohdentamiseen. Voit hyväksyä kaikki, hylätä kaikki tai valita mieltymykset.'
      assign accept_label = 'Hyväksy kaikki'
      assign deny_label = 'Hylkää kaikki'
      assign pref_label = 'Asetukset'
      assign manage_label = 'Hallitse evästeitä'
      assign privacy_label = 'Tietosuojaseloste'
      assign cookie_label = 'Evästekäytännöt'
      assign save_label = 'Tallenna'
      assign func_label = 'Toiminnallisuus'
      assign perf_label = 'Suorituskyky'
      assign targ_label = 'Kohdentaminen'
      assign modal_desc = 'Valitse, mitkä evästetyypit sallitaan. Voit muuttaa milloin tahansa.'
      assign func_desc = 'Välttämättömät evästeet mahdollistavat sivuston ydintoiminnot (turvallisuus, verkon hallinta, saavutettavuus) ja muistavat asetukset kuten kielen ja alueen. Näitä ei voi poistaa käytöstä.'
      assign perf_desc = 'Analytiikkaevästeet keräävät koottuja käyttötietoja, joiden avulla mitataan liikennettä, havaitaan virheitä ja parannetaan nopeutta ja käytettävyyttä. Tietoja käytetään vain suorituskyvyn optimointiin.'
      assign targ_desc = 'Markkinointievästeet personoivat sisältöä ja mainontaa sekä mittaavat kampanjoiden tehokkuutta eri kumppaneilla ja alustoilla. Mukana voi olla kolmannen osapuolen toimijoita.'
    else
      assign banner_title = 'We respect your privacy'
      assign banner_desc = 'We use cookies for essential functionality, performance analytics, and personalized content. You can accept all, deny all, or choose preferences.'
      assign accept_label = 'Accept all'
      assign deny_label = 'Deny all'
      assign pref_label = 'Preferences'
      assign manage_label = 'Manage cookies'
      assign privacy_label = 'Privacy policy'
      assign cookie_label = 'Cookie policy'
      assign save_label = 'Save'
      assign func_label = 'Functionality'
      assign perf_label = 'Performance'
      assign targ_label = 'Targeting'
      assign modal_desc = 'Choose which types of cookies are allowed. You can change this anytime.'
      assign func_desc = 'Essential cookies enable core site features (security, network management, accessibility) and remember settings like language and region. These cannot be switched off.'
      assign perf_desc = 'Analytics cookies collect aggregated usage data to measure traffic, detect errors, and improve speed and usability. Data is used for performance optimization only.'
      assign targ_desc = 'Marketing cookies customize content and ads, and measure campaign effectiveness across partners and platforms. They may involve third-party providers.'
  endcase
%}

<modal-dialog class="modal fixed top-0 left-0 w-full h-full flex items-center justify-center" id="cookie-consent-modal" role="dialog" aria-label="{{ banner_title }}" aria-modal="true" tabindex="-1" data-api-base="{{ section.settings.consent_api_base | strip }}" data-customer-email="{{ customer.email | default: '' }}">
  <div class="modal__window relative bg-theme-bg text-theme-text text-start overflow-hidden has-motion">
    <div class="modal__content flex-auto h-full">
      <div class="consent-header">
        <img class="consent-logo" src="https://cdn.shopify.com/s/files/1/0560/0080/6985/files/HEPHA_Logo_PNG.png?v=1722608803" alt="HEPHA" />
        <button type="button" class="modal__close-btn absolute js-close-modal">{% render 'icon-close' %}<span class="visually-hidden">Close</span></button>
      </div>
      <h3 class="cookie-consent__title">{{ banner_title }}</h3>
      <p class="cookie-consent__desc">{{ banner_desc }}
        <a class="cookie-consent__link" href="{{ privacy_url }}" target="_blank" rel="noopener">{{ privacy_label }}</a> ·
        <a class="cookie-consent__link" href="{{ cookie_url }}" target="_blank" rel="noopener">{{ cookie_label }}</a>
      </p>
      <ul class="cookie-consent__categories">
        <li><strong>{{ func_label }}:</strong> {{ func_desc }}</li>
        <li><strong>{{ perf_label }}:</strong> {{ perf_desc }}</li>
        <li><strong>{{ targ_label }}:</strong> {{ targ_desc }}</li>
      </ul>
      <div class="cookie-consent__actions">
        <button type="button" class="btn cookie-btn cookie-btn--deny" id="cookie-deny">{{ deny_label }}</button>
        <button type="button" class="btn cookie-btn cookie-btn--accept" id="cookie-accept">{{ accept_label }}</button>
        <button type="button" class="btn btn--tertiary cookie-btn cookie-btn--prefs" id="cookie-prefs">{{ pref_label }}</button>
      </div>
      
    </div>
  </div>
</modal-dialog>

<modal-dialog class="modal fixed top-0 left-0 w-full h-full flex items-center justify-center" id="cookie-prefs-modal" role="dialog" aria-label="{{ pref_label }}" aria-modal="true" tabindex="-1">
  <div class="modal__window relative bg-theme-bg text-theme-text text-start overflow-hidden has-motion">
    <div class="modal__content flex-auto h-full">
      <div class="consent-header">
        <img class="consent-logo" src="https://cdn.shopify.com/s/files/1/0560/0080/6985/files/HEPHA_Logo_PNG.png?v=1722608803" alt="HEPHA" />
      </div>
      <h3 class="cookie-prefs__title">{{ pref_label }}</h3>
      <p class="cookie-prefs__desc">{{ modal_desc }} <a class="cookie-banner__link" href="{{ privacy_url }}" target="_blank" rel="noopener">{{ privacy_label }}</a></p>
      <div class="cookie-prefs__groups">
        <div class="cookie-prefs__item">
          <label class="cookie-prefs__label" for="pref-func"><input type="checkbox" id="pref-func" checked /><span class="cookie-toggle" aria-hidden="true"></span> {{ func_label }}</label>
          <div class="cookie-prefs__item-desc">{{ func_desc }}</div>
        </div>
        <div class="cookie-prefs__item">
          <label class="cookie-prefs__label" for="pref-perf"><input type="checkbox" id="pref-perf" checked /><span class="cookie-toggle" aria-hidden="true"></span> {{ perf_label }}</label>
          <div class="cookie-prefs__item-desc">{{ perf_desc }}</div>
        </div>
        <div class="cookie-prefs__item">
          <label class="cookie-prefs__label" for="pref-targ"><input type="checkbox" id="pref-targ" checked /><span class="cookie-toggle" aria-hidden="true"></span> {{ targ_label }}</label>
          <div class="cookie-prefs__item-desc">{{ targ_desc }}</div>
        </div>
      </div>
      <div class="cookie-prefs__actions">
        <button type="button" class="btn cookie-btn cookie-btn--save" id="cookie-save">{{ save_label }}</button>
        <button type="button" class="btn cookie-btn cookie-btn--accept-all" id="cookie-accept-all">{{ accept_label }}</button>
      </div>
    </div>
  </div>
</modal-dialog>


<script type="text/plain" id="consent-api-routes">
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const app = express();
const db = new sqlite3.Database(process.env.CONSENT_DB || './consent.db');
db.serialize(() => {
  db.run('CREATE TABLE IF NOT EXISTS consents (\n    id TEXT,\n    email TEXT,\n    privacy INTEGER,\n    terms INTEGER,\n    marketing INTEGER,\n    preferences INTEGER,\n    status TEXT,\n    timestamp INTEGER,\n    consent_time TEXT,\n    ip TEXT,\n    userAgent TEXT,\n    received_at TEXT\n  )');
});
app.use(express.json());
app.use((req, res, next) => { res.setHeader('Access-Control-Allow-Origin', '*'); res.setHeader('Access-Control-Allow-Headers', 'Content-Type'); res.setHeader('Access-Control-Allow-Methods', 'GET,POST,OPTIONS'); if (req.method === 'OPTIONS') return res.sendStatus(204); next(); });
app.post('/api/consent', (req, res) => {
  const h = req.headers || {};
  const fwd = (h['x-forwarded-for'] || '').split(',')[0].trim();
  const ip = fwd || h['cf-connecting-ip'] || h['x-real-ip'] || h['fastly-client-ip'] || req.socket.remoteAddress || '';
  const ua = req.headers['user-agent'] || '';
  const now = new Date();
  const b = req.body || {};
  const row = [
    b.id || null,
    b.email || null,
    b.privacy ? 1 : 0,
    b.terms ? 1 : 0,
    b.marketing ? 1 : 0,
    typeof b.preferences === 'number' ? b.preferences : null,
    b.status || null,
    typeof b.timestamp === 'number' ? b.timestamp : Math.floor(now.getTime()/1000),
    b.consent_time || now.toISOString(),
    ip,
    ua,
    now.toISOString()
  ];
  db.run('INSERT INTO consents (id,email,privacy,terms,marketing,preferences,status,timestamp,consent_time,ip,userAgent,received_at) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)', row, function(err){
    if (err) return res.status(500).json({ ok: false });
    res.status(201).json({ ok: true, ip: ip });
  });
});
app.get('/api/consent', (req, res) => {
  const limit = parseInt(req.query.limit || '100', 10);
  db.all('SELECT id,email,privacy,terms,marketing,preferences,status,timestamp,consent_time,ip,userAgent,received_at FROM consents ORDER BY rowid DESC LIMIT ?', [limit], (err, rows) => {
    if (err) return res.status(500).json({ ok: false });
    res.json({ consents: rows });
  });
});
if (require.main === module) {
  const port = process.env.PORT || 3000;
  app.listen(port, () => {});
}
module.exports = app;
</script>

<style>
  #shopify-section-{{ section.id }} .cookie-consent__title { margin: 0 0 8px; font-size: 20px; }
  #shopify-section-{{ section.id }} .cookie-consent__desc { margin: 0 0 16px; font-size: 14px; color: #475569; }
  #shopify-section-{{ section.id }} .cookie-consent__link { color: #2563eb; text-decoration: underline; text-underline-offset: 2px; }
  #shopify-section-{{ section.id }} .cookie-consent__actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; border-top: 1px solid #e5e7eb; padding-top: 12px; position: sticky; bottom: 0; background: #ffffff; }
  #shopify-section-{{ section.id }} .cookie-consent__links { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
  #shopify-section-{{ section.id }} .cookie-consent__actions .btn { flex: 1; min-width: 160px; }
  #shopify-section-{{ section.id }} .cookie-btn--prefs::after { content: '›'; display: inline-block; margin-left: 6px; font-weight: 700; }
  
  #shopify-section-{{ section.id }} .cookie-btn { background: #000000; color: #ffffff; border: 2px solid #000000; border-radius: 8px; transition: background-color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease; }
  #shopify-section-{{ section.id }} .cookie-btn:hover, 
  #shopify-section-{{ section.id }} .cookie-btn:focus { background: #111111; border-color: #111111; transform: translateY(-1px); box-shadow: 0 8px 16px rgba(0,0,0,.2); }
  #shopify-section-{{ section.id }} .cookie-btn:active { transform: translateY(-0.5px); box-shadow: 0 4px 8px rgba(0,0,0,.16); }
  #shopify-section-{{ section.id }} .cookie-btn--prefs { background: #e5e7eb; color: #111827; border: 2px solid #d1d5db; transition: background-color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease; }
  #shopify-section-{{ section.id }} .cookie-btn--prefs:hover, 
  #shopify-section-{{ section.id }} .cookie-btn--prefs:focus { background: #d1d5db; border-color: #cbd5e1; color: #000000; transform: translateY(-1px); box-shadow: 0 8px 16px rgba(0,0,0,.15); }

  #shopify-section-{{ section.id }} .consent-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  #shopify-section-{{ section.id }} .consent-logo { height: 28px; }

  #shopify-section-{{ section.id }} .cookie-prefs__title { margin: 0 0 10px; }
  #shopify-section-{{ section.id }} .cookie-prefs__desc { margin: 0 0 12px; color: rgb(var(--text-2)); }
  #shopify-section-{{ section.id }} .cookie-prefs__groups { display: grid; gap: 12px; }
  #shopify-section-{{ section.id }} .cookie-prefs__item { display: grid; grid-template-columns: auto 1fr; column-gap: 8px; row-gap: 4px; align-items: start; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
  #shopify-section-{{ section.id }} .cookie-prefs__label { display: inline-flex; align-items: center; gap: 12px; font-weight: 600; justify-content: space-between; width: 100%; }
  #shopify-section-{{ section.id }} .cookie-prefs__label input { position: absolute; left: -9999px; }
  #shopify-section-{{ section.id }} .cookie-toggle { position: relative; width: 42px; height: 24px; border-radius: 9999px; background: #e5e7eb; box-shadow: inset 0 0 0 1px #cbd5e1; flex: 0 0 auto; }
  #shopify-section-{{ section.id }} .cookie-toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 9999px; background: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,.15); transition: transform .15s ease; }
  #shopify-section-{{ section.id }} .cookie-prefs__label input:checked + .cookie-toggle { background: #0f172a; border-color: #0f172a; }
  #shopify-section-{{ section.id }} .cookie-prefs__label input:checked + .cookie-toggle::after { transform: translateX(18px); }
  #shopify-section-{{ section.id }} .cookie-prefs__item-desc { grid-column: 1 / -1; color: rgb(var(--text-2)); font-size: 13px; }
  #shopify-section-{{ section.id }} .cookie-prefs__actions { margin-top: 14px; display: flex; gap: 12px; justify-content: space-between; }
  #shopify-section-{{ section.id }} .cookie-btn--save { background: #000000; color: #ffffff; border: 2px solid #000000; }
  #shopify-section-{{ section.id }} .cookie-btn--accept-all { background: #000000; color: #ffffff; border: 2px solid #000000; }
  @media (max-width: 767.98px) { #shopify-section-{{ section.id }} .cookie-consent__actions { justify-content: space-between; } }
  #shopify-section-{{ section.id }} modal-dialog.modal:not([open]) { display: none; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    var consentModal = document.getElementById('cookie-consent-modal');
    var btnAccept = document.getElementById('cookie-accept');
    var btnDeny = document.getElementById('cookie-deny');
    var btnPrefs = document.getElementById('cookie-prefs');
    var prefsModal = document.getElementById('cookie-prefs-modal');
    var btnSave = document.getElementById('cookie-save');
    var btnAcceptAllBottom = document.getElementById('cookie-accept-all');
    var reopenSelector = '[data-open-cookie-prefs]';
    function getCookie(name){
      var cookieString = '; ' + document.cookie;
      var parts = cookieString.split('; ' + name + '=');
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    function setCookie(name, value, days){
      var expires = '';
      if (days){ var d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires = '; expires=' + d.toUTCString(); }
      document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value) + expires + '; path=/; SameSite=Lax';
    }
    function encodePayload(obj){ try { return btoa(JSON.stringify(obj)); } catch(e){ return ''; } }
    function decodePayload(str){
      try {
        var dec = atob(str);
        try { return JSON.parse(dec); } catch(e){
          var out = {}; dec.split(/\n|; /).forEach(function(line){ var kv = line.split(':'); if(kv.length>=2){ var k = kv[0].trim(); var v = kv.slice(1).join(':').trim().replace(/^"|"$/g,''); out[k]=v; } }); return out;
        }
      } catch(e){ return null; }
    }
    function getEndpoint(){ var base = consentModal ? consentModal.getAttribute('data-api-base') : ''; if(!base || base==='https://example.com') return null; return base.endsWith('/api/consent')? base : (base.replace(/\/$/, '') + '/api/consent'); }
    function logConsent(payload){ var ep = getEndpoint(); try { console.log('consent', { endpoint: ep || null, payload: payload }); } catch(e){} if(!ep) return; try { var ok = navigator.sendBeacon(ep, JSON.stringify(payload)); if(!ok){ fetch(ep, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), keepalive: true, mode: 'cors' }).then(function(r){ try { return r.json(); } catch(e){ return null; } }).then(function(d){ if (d) { try { console.log('consent saved', d); } catch(e){} } }).catch(function(){}); } } catch(e){} }
    function nowTs(){ return Math.floor(Date.now()/1000); }
    function makeId(){ try { return crypto.randomUUID(); } catch(e){ return 'id-' + Math.random().toString(36).slice(2); } }
    var customerEmail = consentModal ? (consentModal.getAttribute('data-customer-email') || '') : '';
    function formatLocalTime(){ var d = new Date(); function pad(n){ return (n<10?'0':'')+n; } var off = -d.getTimezoneOffset(); var sign = off>=0?'+':'-'; var oh = Math.floor(Math.abs(off)/60); var om = Math.abs(off)%60; var offset = sign + pad(oh) + ':' + pad(om); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds())+' '+offset; }
    function getCountryInfo(){ var loc = null; try { loc = Intl.DateTimeFormat().resolvedOptions().locale; } catch(e){} if (!loc) { loc = (navigator.languages && navigator.languages[0]) || navigator.language || null; } var code = null; if (loc) { var parts = String(loc).split(/-|_/); if (parts.length>=2) { var last = parts[parts.length-1]; if (/^[A-Z]{2}$/.test(last)) code = last; } }
      var name = null; try { if (code && typeof Intl.DisplayNames === 'function') { var dn = new Intl.DisplayNames(['en'], { type: 'region' }); name = dn.of(code); } } catch(e){}
      return { locale: loc || null, country_code: code || null, country: name || null }; }
    function prefsDetail(status){ var fAllowed, pAllowed, tAllowed; if (status === 'allow') { fAllowed = true; pAllowed = true; tAllowed = true; } else if (status === 'deny') { fAllowed = false; pAllowed = false; tAllowed = false; } else { var f = document.getElementById('pref-func'); var p = document.getElementById('pref-perf'); var t = document.getElementById('pref-targ'); fAllowed = !!(f && f.checked); pAllowed = !!(p && p.checked); tAllowed = !!(t && t.checked); } var types = []; if (fAllowed) types.push('functionality'); if (pAllowed) types.push('performance'); if (tAllowed) types.push('targeting'); return { functionality: fAllowed, performance: pAllowed, targeting: tAllowed, types: types }; }
    function writeConsent(status, prefs){ var id = makeId(); var ts = nowTs(); var detail = prefsDetail(status); var tz = (typeof Intl !== 'undefined' && Intl.DateTimeFormat && Intl.DateTimeFormat().resolvedOptions ? Intl.DateTimeFormat().resolvedOptions().timeZone : null); var region = getCountryInfo(); var payload = { id: id, email: (customerEmail || null), preferences: prefs, preferences_detail: detail, status: status, timestamp: ts, consent_time: formatLocalTime(), timezone: tz, country: region.country, country_code: region.country_code, locale: region.locale, userAgent: navigator.userAgent, type: 'cookie_consent' }; setCookie('_pandectes_gdpr', encodePayload(payload), 395); logConsent(payload); }
    var existing = getCookie('_pandectes_gdpr');
    function openConsent(){ if (consentModal) { if (typeof consentModal.open === 'function') { consentModal.open(document.body); } else { consentModal.setAttribute('open',''); } } }
    (function(){ var hasConsent = false; if (existing) { var payload = decodePayload(existing); if (payload && (payload.status === 'allow' || payload.status === 'deny' || payload.status === 'custom')) { hasConsent = true; } } if (!hasConsent) { openConsent(); } })();
    if (btnAccept) btnAccept.addEventListener('click', function(){ writeConsent('allow', 0); if (consentModal) { if (typeof consentModal.close === 'function') { consentModal.close(); } else { consentModal.removeAttribute('open'); document.body.classList.remove('fixed'); document.body.style.top = ''; } } });
    if (btnDeny) btnDeny.addEventListener('click', function(){ writeConsent('deny', 7); if (consentModal) { if (typeof consentModal.close === 'function') { consentModal.close(); } else { consentModal.removeAttribute('open'); document.body.classList.remove('fixed'); document.body.style.top = ''; } } });
    function openPrefs(){ if (prefsModal && typeof prefsModal.open === 'function') { prefsModal.open(btnPrefs || document.body); } else if (prefsModal) { prefsModal.setAttribute('open', ''); } if (consentModal) { if (typeof consentModal.close === 'function') { consentModal.close(); } else { consentModal.removeAttribute('open'); document.body.classList.remove('fixed'); document.body.style.top = ''; } } }
    function closePrefs(){ if (prefsModal) { if (typeof prefsModal.close === 'function') { prefsModal.close(); } else { prefsModal.removeAttribute('open'); } } openConsent(); }
    if (btnPrefs) btnPrefs.addEventListener('click', openPrefs);
    document.addEventListener('click', function(e){ var t = e.target.closest(reopenSelector); if (t) { e.preventDefault(); openPrefs(); } });
    window.CookieConsent = { open: function(){ openConsent(); }, openPreferences: function(){ openPrefs(); } };
    
    if (btnSave) btnSave.addEventListener('click', function(){
      var f = document.getElementById('pref-func');
      var p = document.getElementById('pref-perf');
      var t = document.getElementById('pref-targ');
      var prefs = 0;
      if (!f || !f.checked) prefs = prefs | 1;
      if (!p || !p.checked) prefs = prefs | 2;
      if (!t || !t.checked) prefs = prefs | 4;
      var status = (prefs === 0) ? 'allow' : ((prefs === 7) ? 'deny' : 'custom');
      writeConsent(status, prefs);
      closePrefs();
      if (consentModal) { if (typeof consentModal.close === 'function') { consentModal.close(); } else { consentModal.removeAttribute('open'); document.body.classList.remove('fixed'); document.body.style.top = ''; } }
    });
    if (btnAcceptAllBottom) btnAcceptAllBottom.addEventListener('click', function(){ writeConsent('allow', 0); if (prefsModal) { if (typeof prefsModal.close === 'function') { prefsModal.close(); } else { prefsModal.removeAttribute('open'); } } if (consentModal) { if (typeof consentModal.close === 'function') { consentModal.close(); } else { consentModal.removeAttribute('open'); document.body.classList.remove('fixed'); document.body.style.top = ''; } } });
    if (prefsModal) { var pcs = prefsModal.querySelectorAll('.js-close-modal'); if (pcs && pcs.length) { pcs.forEach(function(b){ b.addEventListener('click', function(){ closePrefs(); }); }); } }
  });
</script>

{% schema %}
{
  "name": "Cookie Banner",
  "settings": [
    { "type": "url", "id": "privacy_policy_url", "label": "Privacy policy link" },
    { "type": "url", "id": "cookie_policy_url", "label": "Cookie policy link" },
    { "type": "text", "id": "consent_api_base", "label": "Consent API base URL", "default": "https://example.com" }
  ],
  "presets": [{ "name": "Cookie Banner" }],
  "disabled_on": { "groups": ["header", "footer"] }
}
{% endschema %}
