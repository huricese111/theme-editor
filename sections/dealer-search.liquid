{%- comment -%}
/**
 * DEALER SEARCH SECTION
 * 
 * This section provides a comprehensive dealer/store locator functionality with interactive map integration.
 * It allows users to search for nearby dealers, rental stations, and service centers with advanced filtering
 * and multi-language support.
 * 
 * MAIN FEATURES:
 * - Interactive Google Maps integration with custom markers
 * - Advanced search with location-based filtering
 * - Multi-language support (English, German, French, Finnish)
 * - Store type filtering (Dealer, Rental Station, Service Center)
 * - Distance and results limit controls
 * - Responsive design with split-screen layout
 * - Search suggestions and history
 * - Custom map styles (Default, Silver, Retro, Dark, Night, Aubergine)
 * 
 * DEPENDENCIES AND RELATED FILES:
 * 
 * CSS Files:
 * - /assets/dealer-search.css - Main stylesheet for dealer search functionality
 * 
 * JavaScript Files:
 * - /assets/dealer-search.js - Core search functionality, filtering, and UI interactions
 * - /assets/location-map.js - Google Maps integration and custom map controls
 * 
 * Liquid Snippets:
 * - /snippets/icon-location.liquid - Location pin icon SVG
 * - /snippets/location-map.liquid - Google Maps component wrapper
 * - /snippets/animation-attrs.liquid - Animation attributes for section elements
  * -/snippets/custom-marker-icon.liquid - Custom marker icon
 * 
 * External Dependencies:
 * - Google Maps JavaScript API - For map rendering and geocoding services
 * - Google Maps Embed API - For fallback iframe maps
 * 
 * CONFIGURATION:
 * The section supports the following settings:
 * - Multi-language section titles
 * - Google Maps API key configuration
 * - Map type selection (Dynamic/Embed)
 * - Custom map styling options
 * - Full-width layout toggle
 * - Color scheme selection
 * 
 * BLOCK STRUCTURE:
 * Each location is defined as a 'location' block with the following data:
 * - Store name and type (dealer/rental/service/click-collect)
 * - Complete address information (street, city, state, postal code, country)
 * - Contact details (phone, fax, email, website)
 * - Business hours
 * - Map pin display settings
 * 
 * LOCALIZATION:
 * Supports 4 languages with complete UI translation:
 * - English (en) - Default language
 * - German (de) - Händlersuche
 * - French (fr) - Recherche de Revendeur  
 * - Finnish (fi) - Jälleenmyyjähaku
 * 
 * SEARCH FUNCTIONALITY:
 * - Real-time search with autocomplete suggestions
 * - Search history storage in localStorage
 * - Filter by store type (dealer, rental, service)
 * - Distance radius selection (25km, 50km, 100km, 200km)
 * - Results limit control (25, 50, 100, all)
 * - Advanced search panel with collapsible interface
 * 
 * MAP INTEGRATION:
 * - Dynamic Google Maps with custom markers per store type
 * - Fallback to embedded iframe maps
 * - Custom map styles and themes
 * - Interactive info windows with store details
 * - Automatic geocoding and location centering
 * - Responsive map container with proper aspect ratios
 * 
 * RESPONSIVE DESIGN:
 * - Desktop: Split-screen layout (3:7 ratio) with fixed sidebar
 * - Mobile: Stacked layout with scrollable results
 * - Touch-friendly controls and interactions
 * - Optimized for various screen sizes
 * 
 * PERFORMANCE CONSIDERATIONS:
 * - Lazy loading of Google Maps API
 * - Efficient DOM manipulation for search results
 * - Debounced search input for better performance
 * - Minimal re-renders during filtering operations
 * 
 * ACCESSIBILITY:
 * - Proper ARIA labels and roles
 * - Keyboard navigation support
 * - Screen reader compatible
 * - High contrast support
 * - Focus management for interactive elements
 */
{%- endcomment -%}

{{ 'dealer-search.css' | asset_url | stylesheet_tag }}
<script src="{{ 'dealer-search.js' | asset_url }}"></script>

{% assign display_map = false %}
{%- assign first_map_address = '' -%}
{%- for block in section.blocks -%}
  {%- if block.type == 'location' and block.settings.address != blank -%}
    {%- if first_map_address == blank -%}
      {%- capture first_map_address -%}
        {{ block.settings.address }}
        {%- if block.settings.city != blank -%}, {{ block.settings.city }}{%- endif -%}
        {%- if block.settings.country != blank -%}, {{ block.settings.country }}{%- endif -%}
      {%- endcapture -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
{%- if section.settings.api_key != blank and first_map_address != blank -%}
  {% assign display_map = true %}
  <script src="{{ 'location-map.js' | asset_url }}" defer></script>
{%- endif -%}

{%- assign section_title = section.settings.section_title_en -%}
{%- case request.locale.iso_code -%}
  {%- when 'de' -%}
    {%- assign section_title = section.settings.section_title_de -%}
  {%- when 'fr' -%}
    {%- assign section_title = section.settings.section_title_fr -%}
  {%- when 'fi' -%}
    {%- assign section_title = section.settings.section_title_fi -%}
  {%- else -%}
    {%- assign section_title = section.settings.section_title_en -%}
{%- endcase -%}

{%- assign direction_text = 'Directions' -%}
{%- case request.locale.iso_code -%}
  {%- when 'de' -%}
    {%- assign direction_text = 'Wegbeschreibung' -%}
  {%- when 'fr' -%}
    {%- assign direction_text = 'Itinéraire' -%}
  {%- when 'fi' -%}
    {%- assign direction_text = 'Reittiohjeet' -%}
  {%- else -%}
    {%- assign direction_text = 'Directions' -%}
{%- endcase -%}

{%- assign placeholder_text = 'Sites nearby' -%}
{%- assign distance_label = 'Distance' -%}
{%- assign results_label = 'Results' -%}
{%- assign search_button_text = 'Search' -%}
{%- assign search_filters_title = 'Search Filters' -%}
{%- assign dealer_text = 'Dealer' -%}
{%- assign rental_station_text = 'Rental Station' -%}
{%- assign service_center_text = 'Service Center' -%}
{%- assign all_text = 'All' -%}
{%- assign phone_label = 'Phone' -%}
{%- assign email_label = 'Email' -%}
{%- assign address_label = 'Address' -%}
{%- assign website_label = 'Website' -%}
{%- assign store_type_label = 'Store Type' -%}
{%- assign more_text = 'More' -%}
{%- assign less_text = 'Less' -%}

{%- case request.locale.iso_code -%}
  {%- when 'de' -%}
    {%- assign placeholder_text = 'Standorte in der Nähe' -%}
    {%- assign distance_label = 'Distanz' -%}
    {%- assign results_label = 'Ergebnisse' -%}
    {%- assign search_button_text = 'Suchen' -%}
    {%- assign search_filters_title = 'Such-Filter' -%}
    {%- assign dealer_text = 'Händler' -%}
    {%- assign rental_station_text = 'Rental Station' -%}
    {%- assign service_center_text = 'Servicezentrum' -%}
    {%- assign all_text = 'Alle' -%}
    {%- assign phone_label = 'Telefon' -%}
    {%- assign email_label = 'E-Mail' -%}
    {%- assign address_label = 'Adresse' -%}
    {%- assign website_label = 'Webseite' -%}
    {%- assign store_type_label = 'Geschäftstyp' -%}
  {%- when 'fr' -%}
    {%- assign placeholder_text = 'Sites à proximité' -%}
    {%- assign distance_label = 'Distance' -%}
    {%- assign results_label = 'Ergebnisse' -%}
    {%- assign search_button_text = 'Recherche' -%}
    {%- assign search_filters_title = 'Filtres de recherche' -%}
    {%- assign dealer_text = 'Revendeur' -%}
    {%- assign rental_station_text = 'Rental Station' -%}
    {%- assign service_center_text = 'Centre de service' -%}
    {%- assign all_text = 'Tous' -%}
    {%- assign phone_label = 'Téléphone' -%}
    {%- assign email_label = 'E-mail' -%}
    {%- assign address_label = 'Adresse' -%}
    {%- assign website_label = 'Site Web' -%}
    {%- assign store_type_label = 'Type de Magasin' -%}
  {%- when 'fi' -%}
    {%- assign placeholder_text = 'Sivustoja lähellä' -%}
    {%- assign distance_label = 'Etäisyys' -%}
    {%- assign results_label = 'Tulokset' -%}
    {%- assign search_button_text = 'Haku' -%}
    {%- assign search_filters_title = 'Hakusuodattimet' -%}
    {%- assign dealer_text = 'Jälleenmyyjä' -%}
    {%- assign rental_station_text = 'Vuokraamo' -%}
    {%- assign service_center_text = 'Huoltokeskus' -%}
    {%- assign all_text = 'Kaikki' -%}
    {%- assign phone_label = 'Puhelin' -%}
    {%- assign email_label = 'Sähköposti' -%}
    {%- assign address_label = 'Osoite' -%}
    {%- assign website_label = 'Verkkosivusto' -%}
    {%- assign store_type_label = 'Myymälän Tyyppi' -%}
{%- endcase -%}

{%- case request.locale.iso_code -%}
  {%- when 'de' -%}
    {%- assign more_text = 'Mehr' -%}
    {%- assign less_text = 'Weniger' -%}
  {%- when 'fr' -%}
    {%- assign more_text = 'Plus' -%}
    {%- assign less_text = 'Moins' -%}
  {%- when 'fi' -%}
    {%- assign more_text = 'Lisää' -%}
    {%- assign less_text = 'Vähemmän' -%}
  {%- else -%}
    {%- assign more_text = 'More' -%}
    {%- assign less_text = 'Less' -%}
{%- endcase -%}

<div class="section-id-{{ section.id }} map-section use-color-scheme use-color-scheme--{{ section.settings.color_scheme }}{% unless section.settings.full_width %} map-section--map-constrained{% endunless %}{% if display_map %} map-section--display-map{% endif %}" {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>
  <div class="container">
    <div class="map-section__wrapper">
      <div class="map-section__locations">
        <div class="dealer-search__fixed-header">
          {% if section_title != blank %}
            <h2 class="dealer-search__title">{{ section_title }}</h2>
          {% endif %}

          <div class="dealer-search__form">
            <div class="search-input-group search-input-group--simple">
              <div class="search-input-wrapper">
                <input type="text" id="location-search" placeholder="{{ placeholder_text }}" class="search-input" style="width:100%;">
              </div>
              <div class="search-simple-controls">
                <button type="button" id="search-btn" class="dealer-search-btn">{{ search_button_text }}</button>
                <button type="button" id="more-btn" class="more-btn">
                  <span class="more-btn__text">{{ more_text }}</span>
                  <svg class="more-btn__arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6,9 12,15 18,9"></polyline>
                  </svg>
                </button>
              </div>
            </div>

            <div class="search-advanced" id="search-advanced" style="display: none;">
              
              <div class="search-filters">
                <h4 class="search-filters__title">{{ search_filters_title }}</h4>
                <div class="filter-options">
                  <label class="filter-option">
                    <input type="checkbox" id="filter-dealer" value="dealer">
                    <span>{{ dealer_text }}</span>
                  </label>
                  <label class="filter-option">
                    <input type="checkbox" id="filter-rental" value="rental">
                    <span>{{ rental_station_text }}</span>
                  </label>
                  <label class="filter-option">
                    <input type="checkbox" id="filter-service" value="service">
                    <span>{{ service_center_text }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="dealer-search__scrollable-results">
          <div class="location-results" id="location-results">
            {%- for block in section.blocks -%}
              {%- case block.type -%}
                {%- when 'location' -%}
                  <div class="map-section__content map-section__text location-card" data-block-id="{{ block.id }}" data-store-name="{{ block.settings.store_name | escape }}" data-address="{{ block.settings.address | escape }}" data-city="{{ block.settings.city | escape }}" data-country="{{ block.settings.country | escape }}" data-postal-code="{{ block.settings.postal_code | escape }}" data-phone="{{ block.settings.phone | escape }}" data-email="{{ block.settings.email | escape }}" data-website="{{ block.settings.website | escape }}" data-hours="{{ block.settings.hours_of_operation | escape }}" data-province="{{ block.settings.province_state | escape }}" data-fax="{{ block.settings.fax | escape }}" data-store-type="{{ block.settings.store_type | escape }}">
                    <!-- 左侧 Marker Icon -->
                    <div class="location-card__marker">
                      {% render 'custom-marker-icon', store_type: block.settings.store_type, size: 'large' %}
                    </div>
                    
                    <div class="location-card__content">
                      {% if block.settings.store_name != blank %}
                        <h3 class="location-card__title">{{ block.settings.store_name | escape }}</h3>
                      {% endif %}

                      {% if block.settings.address != blank %}
                        <div class="location-card__address">
                          {{ block.settings.address | escape }}
                          {% if block.settings.city != blank %}, {{ block.settings.city | escape }}{% endif %}
                          {% if block.settings.postal_code != blank %} {{ block.settings.postal_code | escape }}{% endif %}
                        </div>
                      {% endif %}

                      {% if block.settings.phone != blank %}
                        <div class="location-card__phone">
                          <strong>{{ phone_label }}:</strong> {{ block.settings.phone | escape }}
                        </div>
                      {% endif %}

                      {% if block.settings.email != blank %}
                        <div class="location-card__email">
                          <strong>{{ email_label }}:</strong> {{ block.settings.email | escape }}
                        </div>
                      {% endif %}
                    </div>

                    <!-- 右侧距离和方向按钮 -->
                    <div class="location-card__actions">
                      <div class="location-card__distance" style="display: none;">
                        <span class="distance-value">-- KM</span>
                      </div>
                      
                      {% if block.settings.address != blank %}
                        <div class="location-card__direction">
                          <a href="https://maps.google.com?daddr={{ block.settings.address | escape }}{% if block.settings.city != blank %}, {{ block.settings.city | escape }}{% endif %}{% if block.settings.country != blank %}, {{ block.settings.country | escape }}{% endif %}" target="_blank" class="btn btn--secondary direction-btn">
                            {% if block.settings.show_pin %}
                              <span class="icon">{% render 'icon-location' %}</span>
                            {% endif %}
                            <span>{{ direction_text }}</span>
                          </a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
              {%- endcase -%}
            {%- endfor -%}
          </div>
          
          <!-- Pagination Component -->
          <div class="pagination-container" id="pagination-container">
            <div class="pagination-info">
              <span class="pagination-stats" id="pagination-stats"></span>
            </div>
            
            <div class="pagination-controls">
              <div class="pagination-size-selector">
                <label for="page-size-select" class="page-size-label"></label>
                <select id="page-size-select" class="page-size-select">
                  <option value="10" selected>10</option>
                  <option value="30">30</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
              
              <div class="pagination-navigation">
                <button class="pagination-btn pagination-btn--prev" id="prev-page" disabled>
                  <svg class="pagination-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="15,18 9,12 15,6"></polyline>
                  </svg>
                  <span class="prev-text"></span>
                </button>
                
                <div class="pagination-pages">
                  <input type="number" class="page-input" id="page-input" value="1" min="1">
                  <span class="page-separator">/</span>
                  <span class="total-pages" id="total-pages">1</span>
                </div>
                
                <button class="pagination-btn pagination-btn--next" id="next-page">
                  <span class="next-text"></span>
                  <svg class="pagination-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="9,18 15,12 9,6"></polyline>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="map-section__content map-section__map">
        {%- if display_map -%}
          <div id="map-container" data-api-key="{{ section.settings.api_key }}" data-map-type="{{ section.settings.map_type }}" data-map-style="{{ section.settings.map_style }}">
            {%- if section.settings.map_type == 'dynamic' -%}
              {% render 'location-map', api_key: section.settings.api_key, address: first_map_address, map_style: section.settings.map_style, language: request.locale.iso_code, region: region_code %}
            {%- else -%}
              <iframe id="map-iframe" class="map" src="https://www.google.com/maps/embed/v1/place?key={{ section.settings.api_key }}&q={{ first_map_address }}&zoom=14&language={{ request.locale.iso_code }}&region={{ region_code }}" width="100%" height="100%" frameborder="0" style="border:0" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe>
            {%- endif -%}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Find a dealer",
  "class": "section-map",
  "disabled_on": {
    "groups": ["aside"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Section Title"
    },
    {
      "type": "text",
      "id": "section_title_en",
      "label": "Section Title (English)",
      "default": "Dealer Search"
    },
    {
      "type": "text",
      "id": "section_title_de",
      "label": "Section Title (German)",
      "default": "Händlersuche"
    },
    {
      "type": "text",
      "id": "section_title_fr",
      "label": "Section Title (French)",
      "default": "Recherche de Revendeur"
    },
    {
      "type": "text",
      "id": "section_title_fi",
      "label": "Section Title (Finnish)",
      "default": "Jälleenmyyjähaku"
    },
    {
      "id": "full_width",
      "type": "checkbox",
      "label": "Full page width",
      "default": true
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "1",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ]
    },
    {
      "type": "header",
      "content": "Map"
    },
    {
      "id": "api_key",
      "type": "text",
      "label": "Google Maps API key",
      "default": "AIzaSyBo8kZy19ByPFrx0XR0jrTR5Z6PO5mlaCU",
      "info": "You'll need to [register a Google Maps API Key](https://help.shopify.com/manual/using-themes/troubleshooting/map-section-api-key) to display the map"
    },
    {
      "type": "select",
      "id": "map_type",
      "label": "Map type",
      "info": "The type of map to add. [Learn more](https://mapsplatform.google.com/maps-products/#maps)",
      "options": [
        {
          "value": "dynamic",
          "label": "Dynamic"
        },
        {
          "value": "embed",
          "label": "Embed (free)"
        }
      ],
      "default": "dynamic"
    },
    {
      "type": "select",
      "id": "map_style",
      "label": "Map style",
      "info": "Dynamic map only",
      "default": "default",
      "options": [
        {
          "label": "Default",
          "value": "default"
        },
        {
          "label": "Silver",
          "value": "silver"
        },
        {
          "label": "Retro",
          "value": "retro"
        },
        {
          "label": "Dark",
          "value": "dark"
        },
        {
          "label": "Night",
          "value": "night"
        },
        {
          "label": "Aubergine",
          "value": "aubergine"
        }
      ]
    }
  ],
  "blocks": [
    {
      "type": "location",
      "name": "Location",
      "settings": [
        {
          "type": "header",
          "content": "Basic Information"
        },
        {
          "type": "text",
          "id": "store_name",
          "label": "Store Name",
          "default": "Sportshop Bittner"
        },
        {
          "type": "select",
          "id": "store_type",
          "label": "Store Type",
          "options": [
            {
              "value": "dealer",
              "label": "Dealer"
            },
            {
              "value": "rental",
              "label": "Rental Station"
            },
            {
              "value": "service",
              "label": "Service Center"
            },
            {
              "value": "click-collect",
              "label": "Click and Collect"
            }
          ],
          "default": "dealer"
        },
        {
          "type": "header",
          "content": "Address Information"
        },
        {
          "type": "text",
          "id": "address",
          "label": "Address",
          "default": "Weißestr. 26"
        },
        {
          "type": "text",
          "id": "city",
          "label": "City",
          "default": "Leipzig"
        },
        {
          "type": "text",
          "id": "province_state",
          "label": "Province/State",
          "default": "Sachsen"
        },
        {
          "type": "text",
          "id": "postal_code",
          "label": "Postal/Zip Code",
          "default": "4299"
        },
        {
          "type": "text",
          "id": "country",
          "label": "Country",
          "default": "Germany"
        },
        {
          "type": "header",
          "content": "Contact Information"
        },
        {
          "type": "text",
          "id": "phone",
          "label": "Phone",
          "default": "+49 (0)341 59097850"
        },
        {
          "type": "text",
          "id": "fax",
          "label": "Fax"
        },
        {
          "type": "text",
          "id": "email",
          "label": "Email",
          "default": "steffen@sportshop-bittner.de"
        },
        {
          "type": "text",
          "id": "website",
          "label": "Website",
          "default": "https://sportshop-bittner.de/"
        },
        {
          "type": "header",
          "content": "Business Hours"
        },
        {
          "type": "textarea",
          "id": "hours_of_operation",
          "label": "Hours of Operations",
          "default": "Monday - Friday 10:00 - 18:00\nThursday 10:00 - 19:00\nSaturday 09:00 - 13:00"
        },
        {
          "type": "header",
          "content": "Map Settings"
        },
        {
          "id": "show_pin",
          "type": "checkbox",
          "label": "Show pin",
          "default": true
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Find a dealer",
      "blocks": [
        {
          "type": "location"
        }
      ]
    }
  ]
}
{% endschema %}