# 需求整理：抽取公共同意模块 + 全局配置 + marketing 三态

## 1) 目标
将 `main-register.liquid` 与 `enhanced-form.liquid` 中以下逻辑抽取为**公共模块**（可复用 snippet/section）并支持**主题全局配置（config/settings）**：
- 隐私政策（Privacy Policy）同意勾选 UI
- 服务条款（Terms of Service）同意勾选 UI
-（可选）营销邮件（Marketing Email）同意勾选 UI
- 将同意结果（隐私/条款/营销）发送到日志/consent API 的公共逻辑

同时支持在 `main-register.liquid`、`enhanced-form.liquid` 内选择是否显示营销同意功能：
- 默认不显示
- 只有开关开启才显示营销同意 UI

---

## 2) 模块化方案（结构）
### 2.1 公共模块
- 新建公共模块：`snippets/consent-module.liquid`（名称可调整）
- 职责：
  - 渲染隐私/条款同意 UI
  - 根据传参决定是否渲染营销同意 UI
  - 读取全局 settings 中的 URL/version/API URL
  - 统一组装 payload 并 POST 到 `consent_api_url`

### 2.2 页面引用
在 `main-register.liquid` / `enhanced-form.liquid` 中通过 render 引用：
- `show_marketing_consent` 作为页面级开关参数传入公共模块

示例（示意）：
- `{% render 'consent-module', show_marketing_consent: section.settings.show_marketing_consent %}`

> 若 `main-register` / `enhanced-form` 是 section，建议将 `show_marketing_consent` 放在各自 section schema 中；默认值 false。

---

## 3) 全局主题配置（config/settings）
在 `config/settings_schema.json` 中新增全局配置项（公共模块统一读取）：

- `consent_api_url`：**完整 API URL**
  - ✅ 不再拼接 `/api/consent`
  - ✅ 公共模块直接 POST 到该 URL

- `privacy_policy_url`：隐私政策链接
- `terms_policy_url`：服务条款链接
- `privacy_version`：隐私政策版本号（字符串）
- `terms_version`：服务条款版本号（字符串）

---

## 4) main-register / enhanced-form 去配置要求
既然已经在公共模块里做全局配置，则以下字段在 `main-register.liquid` 与 `enhanced-form.liquid` **不再需要配置/不再出现**：
- `privacy_policy_url`
- `terms_policy_url`
- `consent_api_base`
- `privacy_version`
- `terms_version`

页面只负责：
- 选择是否显示营销同意（通过开关传参）

---

## 5) API URL 设计变更（关键）
### 旧方案（废弃）
- `consent_api_base + '/api/consent'`

### 新方案（采用）
- 主题全局配置填：`consent_api_url`（完整 URL）
- 公共模块直接 POST 到 `consent_api_url`
- **不要保留 `/api/consent` 拼接逻辑**

---

## 6) Marketing 三态规则（true / false / undefined）
### 6.1 当营销功能未开启（show_marketing_consent = false）
- UI：不显示 marketing 勾选
- 上报：`marketing = undefined`
  - 推荐实现：payload 中**不发送 `marketing` 字段**（等同 undefined）

### 6.2 当营销功能已开启（show_marketing_consent = true）
- UI：显示 marketing 勾选
- 上报：
  - 勾选：`marketing = true`
  - 未勾选：`marketing = false`

> 约束：`true/false` 只在 marketing 启用后出现；未启用则统一 `undefined`。

---

## 7) main-register / enhanced-form 改动点汇总
### 必须删除
- 页面内：`privacy_policy_url`, `terms_policy_url`, `consent_api_base`, `privacy_version`, `terms_version` 的任何配置/赋值/常量

### 必须新增/保留
- 页面级开关：`show_marketing_consent`（默认 false）
- render 公共模块时传入该开关

---

## 8) 公共模块上报内容（统一）
公共模块需统一上报隐私/条款/营销同意日志，且读取全局 settings：
- `privacy_policy_url` + `privacy_version`
- `terms_policy_url` + `terms_version`
- marketing 三态按规则处理
- POST endpoint：`consent_api_url`（完整 URL）

---

## 9) 验收标准（Definition of Done）
1. 主题全局可配置：
   - `consent_api_url`（完整 URL）
   - `privacy_policy_url` / `terms_policy_url`
   - `privacy_version` / `terms_version`

2. `main-register.liquid` & `enhanced-form.liquid`：
   - 不再包含：`privacy_policy_url` / `terms_policy_url` / `consent_api_base` / `privacy_version` / `terms_version`
   - 仅保留营销显示开关（默认关闭）

3. marketing 逻辑正确：
   - 开关关闭：UI 不显示；payload 中 marketing = undefined（推荐：字段不存在）
   - 开关开启：UI 显示；勾选 true / 未勾选 false

4. API URL 逻辑正确：
   - 不再拼接 `/api/consent`
   - 配置什么 URL 就请求什么 URL
